<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剧情推演 - AINovalWriter 原型 (v3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest"></script>
    <style>
        /* 自定义滚动条样式 (可选) */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* cool-gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* cool-gray-400 */
        }
        /* 添加简单的加载动画 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
            display: inline-block; /* 使其可以和文字同行 */
        }
        /* 单个卡片加载时的遮罩 */
        .card-loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10; /* 确保在卡片内容之上 */
        }
    </style>
</head>

<body class="bg-gray-100 font-sans antialiased flex flex-col h-screen">

    <nav class="bg-white shadow-md w-full z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 text-indigo-600 font-bold text-xl">
                        AINovalWriter
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#" class="text-gray-500 hover:bg-gray-100 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">小说列表</a>
                            <a href="#" class="text-gray-500 hover:bg-gray-100 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">编辑器</a>
                            <a href="#" class="text-gray-500 hover:bg-gray-100 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">知识库</a>
                            <a href="#" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-md text-sm font-medium" aria-current="page">剧情推演</a>
                            <a href="#" class="text-gray-500 hover:bg-gray-100 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">AI聊天</a>
                            <a href="#" class="text-gray-500 hover:bg-gray-100 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">设置</a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                     <div class="ml-4 flex items-center md:ml-6">
                         <button type="button" class="bg-white p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                             <span class="sr-only">View notifications</span>
                             <img class="h-6 w-6" src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/bell.svg" alt="通知图标">
                         </button>
                         <div class="ml-3 relative">
                             <div>
                                 <button type="button" class="max-w-xs bg-gray-800 rounded-full flex items-center text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                                     <span class="sr-only">Open user menu</span>
                                     <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/E0E7FF/4F46E5?text=U" alt="用户头像">
                                 </button>
                             </div>
                         </div>
                     </div>
                 </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-semibold text-gray-900 mb-6">剧情推演 - 《我的异世界冒险》</h1>

            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <h2 class="text-lg font-medium text-gray-900 mb-4">生成选项</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="start-chapter" class="block text-sm font-medium text-gray-700">上下文开始章节</label>
                        <select id="start-chapter" name="start-chapter" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            <option value="ch1">第一章：意外穿越</option>
                            <option value="ch2">第二章：新手村的麻烦</option>
                            <option value="ch3">第三章：森林试炼</option>
                            </select>
                        <p class="mt-1 text-xs text-gray-500">选择剧情上下文的起始章节。</p>
                    </div>

                     <div>
                        <label for="end-chapter" class="block text-sm font-medium text-gray-700">上下文结束章节</label>
                        <select id="end-chapter" name="end-chapter" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            <option value="ch1">第一章：意外穿越</option>
                            <option value="ch2">第二章：新手村的麻烦</option>
                            <option value="ch3" selected>第三章：森林试炼</option>
                            <option value="ch4">第四章：王都初遇</option>
                            <option value="ch5">第五章：阴谋的端倪</option>
                             </select>
                         <p class="mt-1 text-xs text-gray-500">选择剧情上下文的结束章节。</p>
                    </div>

                    <div>
                        <label for="num-options" class="block text-sm font-medium text-gray-700">生成选项数量</label>
                        <select id="num-options" name="num-options" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            <option>2</option>
                            <option selected>3</option>
                            <option>4</option>
                            <option>5</option>
                        </select>
                    </div>

                    <div class="md:col-span-3">
                        <label for="author-guidance" class="block text-sm font-medium text-gray-700">作者偏好/引导 (可选)</label>
                        <textarea id="author-guidance" name="author-guidance" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="例如：希望侧重角色A的成长；引入新的反派；避免涉及魔法元素..."></textarea>
                        <p class="mt-1 text-xs text-gray-500">告诉 AI 您对下一段剧情的期望或限制。</p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="button" id="generate-button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/brain-circuit.svg" alt="生成图标" class="w-4 h-4 mr-2">
                        生成剧情大纲
                    </button>
                </div>
            </div>

            <div id="results-area">
                <h2 class="text-lg font-medium text-gray-900 mb-4">生成结果</h2>

                <div id="loading-state" class="hidden flex items-center justify-center py-10 text-gray-500">
                    <div class="loading-spinner mr-2"></div>
                    正在生成剧情选项，请稍候...
                </div>

                <div id="empty-state" class="text-center py-10 bg-white rounded-lg shadow">
                    <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/file-question.svg" alt="空状态图标" class="mx-auto h-12 w-12 text-gray-400">
                    <h3 class="mt-2 text-sm font-medium text-gray-900">尚未生成剧情</h3>
                    <p class="mt-1 text-sm text-gray-500">请在上方配置选项后点击“生成剧情大纲”。</p>
                </div>

                <div id="results-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    <template id="result-card-template">
                        <div class="result-card bg-white rounded-lg shadow overflow-hidden flex flex-col relative" data-option-id="">
                            <div class="card-loading-overlay hidden">
                                <div class="loading-spinner"></div>
                            </div>
                            <div class="p-5 flex-1">
                                <h3 class="option-title text-base font-semibold text-indigo-700 mb-2">剧情选项标题</h3>
                                <div class="option-content text-sm text-gray-600 space-y-2">
                                    <p>剧情大纲段落 1。</p>
                                    <p>剧情大纲段落 2。</p>
                                    <p>剧情大纲段落 3。</p>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 border-t border-gray-200 flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-2 flex-grow sm:flex-grow-0">
                                    <select title="选择模型以重新生成此项" class="regenerate-model-select block w-full sm:w-auto rounded-md border-gray-300 py-1 pl-2 pr-7 text-xs focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                                        <option value="model-a">模型 A (默认)</option>
                                        <option value="model-b">模型 B</option>
                                        <option value="model-c">模型 C (创意型)</option>
                                    </select>
                                    <button type="button" title="使用上方选定模型重新生成此项" class="regenerate-single-button p-1.5 text-gray-500 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 rounded">
                                        <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/refresh-cw.svg" alt="刷新图标" class="w-4 h-4">
                                    </button>
                                </div>
                                <button type="button" class="select-outline-button inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/check-circle.svg" alt="选择图标" class="w-3 h-3 mr-1.5">
                                    选择此大纲
                                </button>
                            </div>
                        </div>
                    </template>

                    </div>

                <div id="action-buttons" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <button type="button" id="regenerate-button" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/refresh-cw.svg" alt="刷新图标" class="w-4 h-4 mr-2">
                            重新生成(全部)
                        </button>
                    </div>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
                        <input type="text" id="regenerate-hint" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="输入提示以优化所有生成...">
                        <button type="button" id="regenerate-with-hint-button" class="inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/lightbulb.svg" alt="提示图标" class="w-4 h-4 mr-2">
                            提示并重试(全部)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 简单的交互模拟 (v3)
        const generateButton = document.getElementById('generate-button');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        const resultsGrid = document.getElementById('results-grid');
        const actionButtons = document.getElementById('action-buttons');
        const resultCardTemplate = document.getElementById('result-card-template');
        // 新增：获取上下文选择器
        const startChapterSelect = document.getElementById('start-chapter');
        const endChapterSelect = document.getElementById('end-chapter');
        const numOptionsSelect = document.getElementById('num-options');
        const authorGuidanceTextarea = document.getElementById('author-guidance');


        // --- 模拟数据 ---
        const mockOutlines = [
            { id: 'opt1', title: '意外的盟友', content: '<p>主角一行人在逃亡途中，误入一片古老的森林，遭遇前所未见的魔法生物袭击。</p><p>危急关头，一个之前被认为是敌对势力的神秘角色（角色B）突然出现，帮助他们击退了敌人，但其动机不明。</p><p>主角需要在警惕中决定是否接受这位“盟友”的同行，同时森林深处似乎隐藏着更大的秘密。结尾留下角色B意味深长的眼神特写。</p>' },
            { id: 'opt2', title: '过去的阴影', content: '<p>主角偶然发现了一件遗物，这件遗物揭示了他/她家族一段不为人知的黑暗历史，与当前追杀他们的敌人有着千丝万缕的联系。</p><p>这个发现让主角陷入深深的自我怀疑和道德困境，也让团队内部产生了信任危机。</p><p>敌人似乎也察觉到了遗物的存在，加紧了追捕。主角必须在面对家族过去和保护团队之间做出艰难抉择。</p>' },
            { id: 'opt3', title: '力量的代价', content: '<p>为了应对日益强大的敌人，主角决定寻求一种禁忌的古代力量。寻找力量的过程充满艰险，需要付出巨大代价。</p><p>在获取力量的过程中，主角的心性开始受到影响，变得越来越冷酷和不择手段，引起了同伴（角色C）的担忧和反对。</p><p>虽然获得了强大的力量，但主角也可能因此失去重要的东西。结尾暗示这种力量可能带来反噬。</p>' }
        ];

        // --- 功能函数 ---

        // 清除并填充结果网格
        function populateResultsGrid(outlines) {
            resultsGrid.innerHTML = ''; // 清空现有卡片
            outlines.forEach(outline => {
                const cardClone = resultCardTemplate.content.cloneNode(true);
                const cardElement = cardClone.querySelector('.result-card');
                cardElement.dataset.optionId = outline.id; // 设置唯一ID
                cardElement.querySelector('.option-title').textContent = outline.title;
                cardElement.querySelector('.option-content').innerHTML = outline.content;

                // 为新卡片添加事件监听器
                addCardEventListeners(cardElement);

                resultsGrid.appendChild(cardClone);
            });
             // 显示结果网格和操作按钮
            resultsGrid.classList.remove('hidden');
            actionButtons.classList.remove('hidden');
            emptyState.classList.add('hidden');
            loadingState.classList.add('hidden');
        }

        // 为卡片添加事件监听器 (选择大纲, 单项刷新)
        function addCardEventListeners(cardElement) {
            const selectButton = cardElement.querySelector('.select-outline-button');
            const regenerateButton = cardElement.querySelector('.regenerate-single-button');
            const modelSelect = cardElement.querySelector('.regenerate-model-select');
            const loadingOverlay = cardElement.querySelector('.card-loading-overlay');

            // 选择大纲按钮逻辑 (保持不变)
            selectButton.addEventListener('click', () => {
                document.querySelectorAll('.result-card').forEach(card => {
                    card.classList.remove('ring-2', 'ring-indigo-500');
                    const btn = card.querySelector('.select-outline-button');
                    btn.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700', 'border-transparent');
                    btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50', 'border-gray-300');
                    btn.innerHTML = `<img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/check-circle.svg" alt="选择图标" class="w-3 h-3 mr-1.5"> 选择此大纲`;
                });
                cardElement.classList.add('ring-2', 'ring-indigo-500');
                selectButton.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50', 'border-gray-300');
                selectButton.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700', 'border-transparent');
                selectButton.innerHTML = `<img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/check-circle.svg" alt="选择图标" class="w-3 h-3 mr-1.5"> 已选择`;
                console.log(`选择了大纲: ${cardElement.dataset.optionId} - ${cardElement.querySelector('.option-title').textContent}`);
            });

            // 单项刷新按钮逻辑 (保持不变)
            regenerateButton.addEventListener('click', () => {
                const optionId = cardElement.dataset.optionId;
                const selectedModel = modelSelect.value;
                console.log(`请求重新生成选项 ${optionId} 使用模型 ${selectedModel}`);
                loadingOverlay.classList.remove('hidden');
                setTimeout(() => {
                    const newTitle = `${cardElement.querySelector('.option-title').textContent.split('(')[0].trim()} (模型 ${selectedModel} 新版)`;
                    const newContent = `<p>这是 ${optionId} 使用模型 ${selectedModel} 重新生成的内容。</p><p>模拟更新段落。</p>`;
                    cardElement.querySelector('.option-title').textContent = newTitle;
                    cardElement.querySelector('.option-content').innerHTML = newContent;
                    loadingOverlay.classList.add('hidden');
                    console.log(`选项 ${optionId} 已重新生成`);
                }, 1200);
            });
        }


        // --- 全局按钮事件监听 ---

        // 初始生成按钮 (更新: 读取起止章节)
        generateButton.addEventListener('click', () => {
            // 读取配置
            const startChapter = startChapterSelect.value;
            const endChapter = endChapterSelect.value;
            const numOptions = numOptionsSelect.value;
            const guidance = authorGuidanceTextarea.value;

            console.log('--- 开始生成 ---');
            console.log(`上下文范围: ${startChapter} 到 ${endChapter}`);
            console.log(`生成数量: ${numOptions}`);
            console.log(`作者引导: ${guidance || '无'}`);

            // 隐藏空状态和结果，显示全局加载状态
            emptyState.classList.add('hidden');
            resultsGrid.classList.add('hidden');
            actionButtons.classList.add('hidden');
            loadingState.classList.remove('hidden');

            // 模拟 AI 请求耗时
            setTimeout(() => {
                console.log('模拟生成完成，填充结果...');
                populateResultsGrid(mockOutlines); // 使用模拟数据填充
            }, 1500); // 模拟 1.5 秒延迟
        });

        // 重新生成(全部)按钮 (更新: 传递起止章节)
        const regenerateAllButton = document.getElementById('regenerate-button');
        regenerateAllButton.addEventListener('click', () => {
             const startChapter = startChapterSelect.value;
             const endChapter = endChapterSelect.value;
             console.log(`--- 重新生成(全部) ---`);
             console.log(`上下文范围: ${startChapter} 到 ${endChapter}`);

             resultsGrid.classList.add('hidden');
             actionButtons.classList.add('hidden');
             loadingState.classList.remove('hidden');

             setTimeout(() => {
                 console.log('模拟全部重新生成完成...');
                 const newMockOutlines = mockOutlines.map(o => ({...o, title: `${o.title} (全局刷新)`}));
                 populateResultsGrid(newMockOutlines);
             }, 1500);
        });

        // 提供提示并重试(全部)按钮 (更新: 传递起止章节)
        const regenerateWithHintButton = document.getElementById('regenerate-with-hint-button');
        regenerateWithHintButton.addEventListener('click', () => {
            const hint = document.getElementById('regenerate-hint').value;
            const startChapter = startChapterSelect.value;
            const endChapter = endChapterSelect.value;
            console.log(`--- 提示并重试(全部) ---`);
            console.log(`上下文范围: ${startChapter} 到 ${endChapter}`);
            console.log(`提示: ${hint}`);

            resultsGrid.classList.add('hidden');
            actionButtons.classList.add('hidden');
            loadingState.classList.remove('hidden');

            setTimeout(() => {
                console.log(`模拟根据提示 "${hint}" 重新生成全部...`);
                 const newMockOutlines = mockOutlines.map(o => ({...o, title: `${o.title} (提示: ${hint || '无'})`}));
                 populateResultsGrid(newMockOutlines);
                 document.getElementById('regenerate-hint').value = ''; // 清空提示输入框
            }, 1500);
        });

    </script>

</body>
</html>
