# 侧边栏章节目录与场景摘要加载优化

## 问题分析

分析发现，侧边栏的章节目录展开后未能显示场景组件和摘要的原因是：

1. 数据流问题：服务器返回的场景摘要数据（`/api/v1/novels/get-with-scene-summaries`）没有正确映射到前端模型中
2. 加载时机问题：场景摘要数据应该在SidebarBloc初始化时就加载，而不是点击展开章节才加载
3. 异步处理问题：`preloadChapterScenes`方法返回的是void而不是Future<void>，导致无法正确等待加载完成

## 实现的改进

### 1. 数据模型层改进

创建了两个新的数据模型：
- `SceneSummaryDto`：表示服务器返回的单个场景摘要数据
- `NovelWithSummariesDto`：表示服务器返回的包含所有场景摘要的小说结构

这些模型负责将服务器返回的数据正确映射到前端模型，确保场景摘要能够被正确加载和显示。

### 2. 数据加载流程优化

- 修改了`EditorRepositoryImpl.getNovelWithSceneSummaries`方法，使用新的DTO模型处理服务器返回的数据
- 优化了`SidebarBloc`的实现，确保在加载小说结构时预加载所有场景摘要
- 改进了`_ChapterDirectoryTabState.initState`方法，确保首次加载时就能获取所有章节的场景摘要

### 3. 异步处理改进

- 修改`EditorScreenController.preloadChapterScenes`方法，使其返回`Future<void>`而不是`void`
- 在方法内部使用`Completer`模式确保异步操作能够正确完成和返回
- 添加超时处理，防止无限等待

### 4. UI交互优化

- 修改了`_toggleChapter`方法，优化章节展开和场景加载逻辑
- 改进了`_buildScenesList`方法，添加加载指示器和更好的错误处理
- 优化场景摘要显示，显示场景标题、编辑时间和字数统计

## 核心改进点

1. **预加载机制**：SidebarBloc现在会在初始化时就加载所有章节的场景摘要，而不是等到用户点击展开章节才加载
2. **数据检查**：添加了对加载状态和数据完整性的检查，确保UI能够正确反映数据状态
3. **异步处理**：正确处理了异步操作的完成状态，确保UI能够在数据加载完成后更新
4. **容错处理**：添加了更多的日志和错误处理，使问题更容易诊断和解决

这些改进确保了章节目录能够正确显示场景组件和摘要，提升了用户体验。 