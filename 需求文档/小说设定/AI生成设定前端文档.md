# AI 生成小说设定功能 - 前端需求文档

## 1. 功能概述

本功能为用户提供一个集成在编辑器右侧边栏的 AI 辅助面板。用户可以通过该面板选择小说的起始章节和感兴趣的设定类型，AI 将基于所选章节内容生成相关的设定条目。生成的设定条目会以卡片形式展示，用户可以查看详情、采纳并将其添加到现有的小说设定组中，或选择重新生成。

## 2. 目标用户

小说创作者

## 3. 核心需求

### 3.1. UI 组件与集成

*   **集成方式：**
    *   新的 AI 生成设定面板将作为 `MultiAIPanelView` (路径: `AINoval/lib/screens/editor/components/multi_ai_panel_view.dart`) 中的一种可选面板类型。
    *   `EditorLayoutManager` 需要更新以管理此新面板的可见性和宽度。
    *   `EditorAppBar` (路径: `AINoval/lib/screens/editor/components/editor_app_bar.dart`) 中需要添加一个新的按钮或菜单项（例如，在 "AI生成" 弹出菜单中新增一项 "AI生成设定"），用于切换此面板的显示与隐藏。
*   **面板命名：** "AI 生成设定" (或类似名称，如 "智能设定提取")

### 3.2. 面板内部布局与样式 (现代、简洁、优雅)

新面板整体采用卡片式设计，内部垂直布局，分为配置区和结果展示区。

#### 3.2.1. 面板头部 (由 `MultiAIPanelView` 提供)

*   **标题：** "AI 生成设定"
*   **图标：** 例如 `Icons.auto_fix_high_outlined` 或 `Icons.psychology_outlined` (取其智能之意)。
*   **关闭按钮：** 由 `MultiAIPanelView` 管理。

#### 3.2.2. 配置区 (位于面板上部)

此区域允许用户配置 AI 生成的参数。整体应简洁易懂，使用清晰的标签和现代化的表单控件。

*   **起始章节选择：**
    *   **标签：** "起始章节"
    *   **组件：** 一个样式化的下拉选择器 (DropdownButtonFormField) 或一个可搜索的列表选择器。
    *   **内容：** 动态加载当前打开小说的所有章节列表（章节标题）。
    *   **默认值：** 可考虑默认为当前编辑器内活动章节，或小说第一章。
    *   **样式：** 边框圆角，清晰的选中状态，字体与应用主题一致。
*   **设定类型选择：**
    *   **标签：** "希望生成的设定类型"
    *   **组件：** 一组横向或流式布局的勾选框 (CheckboxListTile 或自定义的 Chip 组件列表，支持多选)。
    *   **选项：** 与后端 `SettingType` 枚举保持一致 (例如：角色, 地点, 物品, 背景知识, 势力, 事件, 概念, 生物, 魔法体系, 科技设定等)。每个选项应有清晰的文本标签。
    *   **样式：** 选中的类型有明显视觉反馈（如背景色变化、勾选标记）。Chip 风格可以使界面更现代。
*   **(可选) 每种类型最大数量：**
    *   **标签：** "每类生成数量 (建议1-5)"
    *   **组件：** 一个小巧的数字输入框 (TextFormField with number input type) 或一个离散的滑块 (Slider)。
    *   **默认值：** 3。
    *   **样式：** 输入框圆角，与整体风格协调。
*   **额外指令/风格要求：**
    *   **标签：** "其他说明或风格引导 (可选)"
    *   **组件：** 一个多行文本输入框 (TextFormField)，有合适的高度（例如 3-4 行），内容可滚动。
    *   **占位提示：** 例如 "希望角色更神秘一些" 或 "侧重于描写地点的历史感"。
    *   **样式：** 圆角边框，清晰的焦点状态。
*   **生成按钮：**
    *   **文本：** "开始生成" 或 "提取设定"
    *   **图标：** 可选，如 `Icons.auto_awesome` 或 `Icons.sparkle_outlined`。
    *   **组件：** `ElevatedButton` 或 `TextButton` (根据视觉风格决定)。
    *   **动作：** 点击后触发向后端发送生成设定的请求。在请求处理期间，按钮应变为禁用状态并显示加载指示（例如按钮内嵌一个小型 `CircularProgressIndicator` 或文本变为 "生成中..."）。
    *   **样式：** 按钮具有圆角，颜色与主题动作色一致。

#### 3.2.3. 结果展示区 (位于面板下部，占据主要空间)

此区域用于展示 AI 生成的设定条目列表。

*   **初始/空状态：**
    *   **条件：** 在用户首次打开面板或未点击生成按钮前，或生成后未返回任何结果时显示。
    *   **内容：** 居中显示提示信息，例如："请选择起始章节和设定类型，然后点击"开始生成"来获取 AI 建议的设定。" 或 "AI 未能根据您的选择生成设定，请尝试调整选项或章节内容后再试。"
    *   **样式：** 文本颜色柔和，可配一个相关的占位图标。
*   **加载状态：**
    *   **条件：** 点击生成按钮后，等待后端返回数据期间。
    *   **显示：**
        *   方案一：在结果区显示一个居中的 `CircularProgressIndicator` 和提示文本 "正在分析章节并生成设定，请稍候..."。
        *   方案二：使用卡片骨架屏 (Shimmer effect on placeholder cards) 来模拟即将加载的内容，提升用户体验。
    *   **样式：** 加载动画流畅，不阻塞 UI。
*   **设定条目列表：**
    *   **组件：** `ListView.builder` 用于高效渲染可能较长的列表。
    *   **滚动条：** 如果列表内容超出面板高度，应显示一个自定义美化的滚动条 (例如使用 `ScrollbarTheme`)。
    *   **条目卡片 (`NovelSettingItemCard`)：** 每个 AI 生成的设定条目显示为一个独立的卡片。
        *   **整体样式：** 现代、简洁、优雅。卡片具有轻微的阴影、圆角。背景色可略浅于面板背景，或使用描边进行区分。间距适中。
        *   **卡片内容布局 (垂直)：**
            1.  **顶部区域：**
                *   **设定名称 (`item.name`)：** 字体稍大、加粗，作为卡片标题。
                *   **设定类型 (`item.type`)：** 以一个小型、带圆角的彩色标签 (Chip) 展示在名称旁边或下方。不同类型可以使用不同颜色（需预定义一套和谐的色彩方案）。例如：角色 (蓝色), 地点 (绿色), 物品 (橙色)。
            2.  **描述区域 (`item.description`)：**
                *   显示设定的详细描述。
                *   如果描述过长，默认显示固定行数（例如 2-3 行），末尾加省略号，并提供 "展开" / "收起" 功能 (例如一个小的向下/向上箭头图标按钮)。展开后平滑显示全部内容。
            3.  **(可选) 属性与标签区域 (`item.attributes`, `item.tags`)：**
                *   **展示时机：** 默认折叠，可在卡片底部提供一个 "查看详情" 按钮，或在用户鼠标悬停在卡片上时浮现/展开。
                *   **属性 (`attributes`)：** 以 "键: 值" 的形式逐行展示，或以小型 Key-Value 风格的 Chips 展示。
                *   **标签 (`tags`)：** 以一组小型、风格一致的 Chips 展示。
            4.  **底部操作区：**
                *   **布局：** 通常靠右对齐，或在卡片底部横向排列。图标按钮比文本按钮更节省空间，更显优雅。
                *   **"采纳此设定" 按钮/图标：**
                    *   **图标：** 例如 `Icons.add_circle_outline` 或 `Icons.check_circle_outline`。
                    *   **文本 (可选，鼠标悬停提示)：** "采纳"
                    *   **动作：**
                        1.  点击后，弹出一个对话框或下拉菜单，列出当前用户创建的所有 `SettingGroup` (设定组)。
                        2.  用户选择一个或多个设定组后，点击确认。
                        3.  前端将此 `NovelSettingItem` (包含其 `id` 和其他从 AI 获取的信息) 及选定的 `groupId` 发送给 `SettingBloc` 的 `CreateSettingItem` 事件 (并附带 `groupId`) 或 `AddItemToGroup` 事件（如果条目已临时创建）。
                        4.  成功采纳后，此卡片可以有状态变化（例如显示"已采纳"标记）或从列表中移除（根据产品逻辑决定）。
                *   **"忽略此条" 按钮/图标 (可选，若不希望用户删除)：**
                    *   **图标：** 例如 `Icons.close` 或 `Icons.visibility_off_outlined`。
                    *   **文本 (可选，鼠标悬停提示)：** "忽略"
                    *   **动作：** 从当前显示的建议列表中移除此卡片 (纯客户端操作，不影响后端)。
                *   **(未来) "基于此条重新生成" 按钮/图标：**
                    *   **图标：** 例如 `Icons.refresh` 或 `Icons.lightbulb_outline`。
                    *   **动作：** 允许用户基于当前条目的内容进行微调或提供额外提示，再次请求 AI 生成。

#### 3.2.4. 面板底部操作区 (可选，若有全局操作)

*   **"全部重新生成" 按钮：**
    *   **条件：** 当结果展示区有内容时显示。
    *   **文本：** "换一批" 或 "重新生成全部"
    *   **动作：** 使用当前配置区的参数，重新调用后端 API 获取一批新的设定建议，并替换现有列表。
*   **"清除结果" 按钮：**
    *   **条件：** 当结果展示区有内容时显示。
    *   **文本：** "清空"
    *   **动作：** 清空结果展示区的设定列表，恢复到初始/空状态。

### 3.3. 用户交互流程

1.  用户通过 `EditorAppBar` 打开 "AI 生成设定" 面板。
2.  面板显示，用户在配置区选择/输入：
    *   起始章节。
    *   一个或多个设定类型。
    *   (可选) 每种类型最大数量。
    *   (可选) 额外指令。
3.  用户点击 "开始生成" 按钮。
4.  按钮变为禁用状态，结果展示区显示加载状态。
5.  前端向后端 `POST /api/novels/{novelId}/ai/generate-settings` 发送请求。
6.  请求成功后，结果展示区显示 AI 生成的设定条目卡片列表。若无结果，则显示空状态。若失败，则显示错误信息。
7.  用户浏览生成的设定条目：
    *   可展开/收起描述过长的条目。
    *   可查看条目的属性和标签 (如果设计为默认折叠)。
8.  用户对单个设定条目进行操作：
    *   点击 "采纳此设定"：
        *   弹出设定组选择器。
        *   用户选择目标设定组。
        *   前端触发 `SettingBloc` 事件，将此设定项添加到选定的组中。
        *   (反馈) 成功后，卡片可更新状态或从列表中移除。
    *   点击 "忽略此条" (如果实现)：卡片从列表中移除。
9.  用户可选择 "全部重新生成" (使用相同配置再次请求) 或 "清除结果"。

### 3.4. 状态管理 (例如，使用独立的 BLoC/Cubit)

*   **状态 (`AISettingGenerationState`)：**
    *   `status`: (enum: initial, loadingChapters, chaptersLoaded, loadingSettings, settingsLoaded, error)
    *   `chapters`: `List<ChapterSummary>` (用于起始章节选择器)
    *   `selectedStartChapterId`: `String?`
    *   `availableSettingTypes`: `List<SettingTypeOption>` (包含标签和选中状态)
    *   `maxSettingsPerType`: `int`
    *   `additionalInstructions`: `String`
    *   `generatedSettings`: `List<NovelSettingItem>` (从后端获取的原始数据)
    *   `errorMessage`: `String?`
*   **事件 (`AISettingGenerationEvent`)：**
    *   `InitializePanel(novelId)`: 加载章节列表等初始数据。
    *   `StartChapterSelected(chapterId)`
    *   `SettingTypeToggled(settingType)`
    *   `MaxSettingsChanged(count)`
    *   `AdditionalInstructionsChanged(text)`
    *   `GenerateSettingsRequested`
    *   `AdoptSettingItem(settingItem, targetGroupId)`
    *   `DismissSettingItem(settingItemId)`
    *   `RegenerateAllRequested`
    *   `ClearResultsRequested`

### 3.5. 与后端交互

*   **获取章节列表：** (如果编辑器控制器不直接提供) 可能需要一个API或从 `EditorBloc` 获取。
*   **生成设定：** 调用 `POST /api/novels/{novelId}/ai/generate-settings`。
    *   请求体包含：`startChapterId`, `settingTypes` (勾选的类型), `maxSettingsPerType`, `additionalInstructions`。
*   **采纳设定：**
    *   调用 `SettingBloc` 的 `CreateSettingItem` 事件，该事件内部会调用 `NovelSettingRepository` 的相应方法将 `NovelSettingItem` 保存到数据库，并关联到 `groupId`。

## 4. 错误处理与用户反馈

*   **表单校验：** 在点击 "开始生成" 前，对必填项（起始章节、至少选择一个设定类型）进行前端校验，并给出友好提示。
*   **API 请求错误：**
    *   在结果展示区清晰显示错误信息，例如："生成设定失败：服务器错误，请稍后再试。" 或后端返回的具体错误消息。
    *   提供一个 "重试" 按钮。
*   **加载反馈：** 确保在数据加载和 AI 生成过程中有明确的加载指示。
*   **操作成功反馈：** "采纳成功" 等操作应有 Toast、Snackbar 或其他即时反馈。

## 5. 非功能性需求

*   **响应性：** 面板在 `MultiAIPanelView` 中拖拽调整大小时，内部元素应能良好自适应。
*   **性能：** 列表滚动流畅，大量卡片渲染不应导致卡顿。
*   **易用性：** 用户操作流程应直观易懂。

## 6. 未来可考虑的增强功能

*   **单条重新生成：** 允许用户针对不满意的单条 AI 生成结果，提供反馈并请求 AI 重新生成。
*   **批量操作：** 支持批量采纳或批量忽略设定。
*   **自定义提示词模板：** 高级用户可以编辑用于生成某类设定的基础提示词。
*   **保存生成偏好：** 记住用户常用的设定类型组合。
*   **与小说内容联动：** 在设定卡片上显示该设定主要来源于小说内容的哪些片段（如果AI能提供此信息）。
