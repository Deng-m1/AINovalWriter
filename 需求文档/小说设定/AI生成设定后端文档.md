# AI 生成小说设定功能 - 后端需求文档

## 1. 功能概述

本功能旨在通过 AI 辅助用户从现有小说章节内容中提取和生成新的小说设定条目。用户在前端选择起始章节和期望生成的设定类型后，后端将整合相关内容，调用大语言模型（LLM）生成结构化的设定信息，并返回给前端供用户筛选和使用。

## 2. 目标用户

小说创作者

## 3. 核心需求

### 3.1. API 端点

*   **路径：** `POST /api/novels/{novelId}/ai/generate-settings`
*   **方法：** `POST`
*   **认证：** 需要用户认证

### 3.2. 请求参数

*   **路径参数：**
    *   `novelId` (String, 必填): 小说ID。
*   **请求体 (JSON):**
    *   `startChapterId` (String, 必填): 用户选择的起始章节ID。内容将从该章节开始（包含该章节）及其后续章节中提取。
    *   `settingTypes` (List<String>, 必填): 用户勾选的希望生成的设定类型列表。例如：`["CHARACTER", "LOCATION", "ITEM", "LORE"]`。该枚举列表需与前端保持一致。
    *   `maxSettingsPerType` (Integer, 可选, 默认值: 3): 每种选定的设定类型希望生成的最大条目数量。
    *   `additionalInstructions` (String, 可选): 用户输入的额外提示或风格要求，用于指导 AI 生成。

### 3.3. 后端处理流程

1.  **请求校验：**
    *   验证用户是否有权限操作该 `novelId`。
    *   校验 `novelId`, `startChapterId`, `settingTypes` 是否有效且存在。
    *   校验 `settingTypes` 中的值是否为预定义的有效枚举值。
2.  **内容组装：**
    *   根据 `novelId` 和 `startChapterId`，从数据库中获取从该章节开始的后续所有章节内容（或关键摘要，具体策略待定，需考虑性能和上下文长度限制）。
    *   将获取到的章节内容整合成一段连贯的文本作为 AI 的主要上下文输入。
3.  **提示词构建：**
    *   **基础指令：** 指导 AI 扮演一个小说设定分析师或世界构建助手。
    *   **任务描述：** 明确要求 AI 根据提供的上下文文本，识别并生成与用户选定的 `settingTypes` 相关的设定条目。
    *   **输出格式要求：**
        *   强调 AI 需要返回一个结构化的数据，格式为 JSON 数组。
        *   数组中的每个对象代表一个独立的 `NovelSettingItem`。
        *   每个对象必须包含以下字段：
            *   `name` (String): 设定的名称。
            *   `type` (String): 设定的类型，必须是用户请求的 `settingTypes` 中的一种。
            *   `description` (String): 对该设定的详细描述。
            *   `attributes` (Map<String, String>, 可选): 设定的其他属性键值对。
            *   `tags` (List<String>, 可选): AI 建议的与该设定相关的标签。
        *   提供一个清晰的 JSON 结构示例。
    *   **设定类型指导：** 针对每种选定的 `settingType`，可以提供简要的说明或期望生成的侧重点。例如：
        *   **CHARACTER:** "生成角色设定，包括其可能的性格特点、外貌简述、背景故事线索或在当前上下文中的作用。"
        *   **LOCATION:** "生成地点设定，包括其环境特征、重要性、氛围或发生的关键事件。"
        *   **ITEM:** "生成物品设定，包括其外观、功能、来源或对剧情的潜在影响。"
        *   **LORE:** "提取或生成世界观、历史背景、传说、规则等相关的背景知识设定。"
    *   **数量要求：** 提醒 AI 针对每种选定的 `settingType` 生成大约 `maxSettingsPerType` 个条目。
    *   **用户额外指令：** 将用户提供的 `additionalInstructions` 融入提示词。
    *   **上下文注入：** 将步骤2中组装好的小说内容作为核心上下文注入。
4.  **AI 模型调用：**
    *   获取用户账户下配置的默认大模型，优先使用 Google AI Gemini 提供商。
    *   以**非流式**方式向 LLM 发送构建好的提示词。
    *   设置合理的超时时间。
5.  **响应解析与数据转换：**
    *   接收 LLM 返回的结构化数据（预期为 JSON 字符串）。
    *   解析 JSON 字符串为 `List<Map<String, Object>>` 或类似的中间结构。
    *   将每个解析出的对象转换为 `NovelSettingItem` 实例：
        *   `id`: 生成新的 UUID。
        *   `novelId`: 从请求中获取。
        *   `userId`: 当前登录用户ID。
        *   `name`, `type`, `description`, `attributes`, `tags`: 从 AI 返回的数据中获取。
        *   `priority`: 设置默认值 (例如 3)。
        *   `generatedBy`: 固定值为 "AI\_SETTING\_GENERATION" (或更具体的类型，如 "AI\_CHAPTER\_ANALYSIS\_SETTING")。
        *   `status`: 固定值为 "SUGGESTED"。
        *   `isAiSuggestion`: 固定值为 `true`。
        *   `createdAt`, `updatedAt`: 设置为当前时间。
        *   `sceneIds`: 留空或根据上下文关联（本次需求是从章节开始，暂不强关联特定场景）。
        *   `imageUrl`, `relationships`: 留空。
        *   `vector`: 暂不生成向量。
6.  **数据持久化：**
    *   **不立即保存到数据库。** 生成的设定条目仅作为建议返回给前端。用户在前端确认采纳后，再通过专门的接口创建或更新设定条目。

### 3.4. 成功响应 (HTTP 200 OK)

*   **响应体 (JSON):**
    *   返回一个 `NovelSettingItem` 对象的数组。
    *   `Content-Type: application/json`

    ```json
    [
        {
            "id": "uuid-generated-by-backend-1",
            "novelId": "current-novel-id",
            "userId": "current-user-id",
            "name": "AI Generated Character Name",
            "type": "CHARACTER",
            "description": "Detailed description of the character generated by AI.",
            "attributes": { "eye_color": "blue", "hair_color": "black" },
            "imageUrl": null,
            "relationships": [],
            "sceneIds": [],
            "priority": 3,
            "generatedBy": "AI_SETTING_GENERATION",
            "tags": ["protagonist_potential", "mysterious_past"],
            "status": "SUGGESTED",
            "vector": null,
            "createdAt": "timestamp",
            "updatedAt": "timestamp",
            "isAiSuggestion": true,
            "metadata": {}
        },
        // ... more setting items
    ]
    ```

### 3.5. 错误处理与异常流程

*   **400 Bad Request:** 请求参数缺失或无效 (例如 `novelId` 为空, `startChapterId` 无效, `settingTypes` 为空或包含无效类型)。
*   **401 Unauthorized:** 用户未登录。
*   **403 Forbidden:** 用户无权访问该小说。
*   **404 Not Found:** `novelId` 或 `startChapterId` 对应的数据未找到。
*   **500 Internal Server Error:**
    *   AI 模型调用失败 (超时、API错误、内容安全策略拒绝等)。
    *   AI 返回的数据格式不正确，无法解析。
    *   后端内部逻辑错误。
*   **错误响应体 (JSON):**
    ```json
    {
        "timestamp": "iso_datetime",
        "status": http_status_code,
        "error": "Error Category",
        "message": "Detailed error message",
        "path": "/api/novels/{novelId}/ai/generate-settings"
    }
    ```

## 4. 数据模型

### 4.1. `NovelSettingItem` (复用现有模型)

确保以下字段能够被 AI 生成的逻辑正确填充：

*   `name` (String)
*   `type` (String) - 对应 `SettingType` 枚举
*   `description` (String)
*   `attributes` (Map<String, String>)
*   `tags` (List<String>)
*   `generatedBy` (String) - 例如："AI\_SETTING\_GENERATION"
*   `status` (String) - 例如："SUGGESTED"
*   `isAiSuggestion` (boolean) - `true`

### 4.2. `SettingType` 枚举 (需前后端统一)

定义小说设定的类型，例如：

*   `CHARACTER` (角色)
*   `LOCATION` (地点)
*   `ITEM` (物品)
*   `LORE` (背景知识/传说)
*   `FACTION` (组织/势力)
*   `EVENT` (事件)
*   `CONCEPT` (概念/规则)
*   `CREATURE` (生物/种族)
*   `MAGIC_SYSTEM` (魔法体系)
*   `TECHNOLOGY` (科技设定)
    *...其他可扩展类型*

## 5. 提示词工程关键点

*   **角色扮演：** "你是一位经验丰富的小说设定挖掘与创造助手..."
*   **任务明确：** "请仔细阅读以下提供的小说片段，并根据用户指定的设定类型，提取或创造相关的设定条目。"
*   **上下文提供：** 清晰地将组装好的小说内容作为上下文提供给 AI。
*   **结构化输出要求：**
    *   "请严格按照以下JSON格式返回你的分析结果。返回一个包含多个设定对象的JSON数组。每个对象代表一个独立的设定条目，并必须包含 `name`, `type`, 和 `description` 字段。可选字段包括 `attributes` (一个键值对对象) 和 `tags` (一个字符串数组)。"
    *   提供清晰的JSON输出格式示例，包含所有必需和可选字段。
    *   例如:
        ```json
        // 示例开始
        [
          {
            "name": "阿尔卡纳法杖",
            "type": "ITEM",
            "description": "一根古老的法杖，据传由失落文明的工匠用星辰碎片和月光编织而成。杖身刻有微光的符文，能放大持有者的元素魔法，但使用不当会反噬其主。",
            "attributes": {
              "材质": "星辰碎片、月光丝线、黑曜石",
              "能力": "增幅元素魔法、未知潜能",
              "副作用": "过度使用可能导致精力枯竭或符文反噬"
            },
            "tags": ["魔法物品", "古代遗物", "高风险高回报"]
          },
          {
            "name": "影刃豹",
            "type": "CREATURE",
            "description": "一种栖息在幽暗森林深处的猫科生物，体型矫健，毛皮漆黑如夜，能融入阴影之中。它们以速度和利爪著称，是森林中的顶级掠食者之一。",
            "attributes": {
              "栖息地": "幽暗森林",
              "特征": "融入阴影、速度极快、爪牙锋利",
              "习性": "夜行、独居或小群体狩猎"
            },
            "tags": ["魔法生物", "掠食者", "隐匿"]
          }
        ]
        // 示例结束
        ```
*   **类型指导：** "当生成 `CHARACTER` 类型时，请侧重于其性格、动机或在故事中的作用；当生成 `LOCATION` 类型时，请描述其环境特征和氛围..."
*   **多样性与相关性：** "请确保生成的设定既与提供的文本内容紧密相关，又具有一定的创新性和多样性。避免简单重复文本内容。"
*   **数量控制：** "针对用户选择的每种设定类型，请尝试生成大约 X 个设定条目。"

## 6. 非功能性需求

*   **性能：** API 响应时间应在合理范围内（例如，对于中等长度的上下文，争取在 30-60 秒内返回，具体取决于 LLM 的响应速度）。
*   **可扩展性：** 未来可以支持更多设定类型，或更复杂的上下文处理逻辑。
*   **可配置性：** 默认 LLM 模型、提示词模板等应易于配置和调整。

## 7. 未来可考虑的增强功能

*   支持用户选择不同的 AI 模型进行生成。
*   允许用户在生成前调整更细致的 AI 参数（如温度、top_p 等）。
*   AI 生成设定时，尝试关联已有的其他设定条目。
*   对章节内容进行更智能的切片或摘要，以适应不同模型的上下文长度限制。
