# Product Requirements Document: AINovalWriter Background Task System

**Version:** 1.0
**Date:** 2024-07-27
**Author:** AI Assistant (acting as PM)
**Status:** Draft

**1. Introduction & Overview**

AINovalWriter aims to enhance the novel writing process through AI integration. Currently, features like AI-driven scene and summary generation are executed synchronously. While suitable for quick interactions, this approach becomes problematic for time-consuming operations or batch processing, potentially blocking the user interface and degrading the user experience.

This document outlines the requirements for a **Background Task System**. This system will run alongside the existing synchronous functionalities, offering users an alternative execution mode for specific tasks. Users can choose to delegate long-running or batch operations to this system, allowing them to continue using the application without interruption. The system will provide visibility into task progress and allow users to retrieve results upon completion, similar in concept to a download manager.

**2. Goals**

*   **Improve User Experience:** Prevent UI freezes during long-running AI operations or batch processing.
*   **Enable Batch Processing:** Provide a robust mechanism for users to apply AI generation or other intensive tasks to multiple parts of their novel (e.g., entire chapters, specified ranges) efficiently.
*   **Increase System Resilience:** Handle transient errors (network issues, API timeouts) during long tasks more gracefully through retries and clear status reporting.
*   **Provide User Feedback:** Offer users clear visibility into the status, progress, and results of their background tasks.
*   **Foundation for Future Features:** Create an extensible framework to support more complex, multi-step background workflows in the future.
*   **Maintain Synchronous Option:** Ensure users can still opt for immediate, synchronous execution for quick AI tasks when desired.

**3. Background & Motivation**

The need for a background task system arises from:

*   **Long-Running AI Calls:** Generating detailed scene content or summarizing lengthy scenes can take significant time, blocking the UI in a synchronous model.
*   **Batch Operations:** Users require the ability to perform actions like "generate summaries for all scenes in Chapter X" or "generate scene content for outlines A, B, and C". Executing these synchronously is impractical.
*   **API/Network Unreliability:** Interactions with external LLMs are susceptible to network latency, timeouts, or temporary service unavailability. Background tasks allow for better management of these issues (e.g., retries).
*   **Resource Management:** Offloading intensive tasks prevents them from hogging primary application threads, improving overall application responsiveness.

By implementing this system, we empower users with the flexibility to choose the execution mode best suited for their immediate needs, significantly enhancing usability for complex AI interactions and large-scale novel management. The "download manager" analogy helps set user expectations: submit a task, monitor its progress, and access the results when ready.

**4. Scope**

**In Scope (Version 1.0):**

*   Backend framework for defining, queuing, executing, and managing background tasks within `AINovalServer`.
*   Persistence of task state and results (using MongoDB).
*   API endpoints for creating, querying (list & single task), and cancelling background tasks.
*   API endpoint/mechanism to retrieve and potentially "apply" the results of a completed task.
*   Implementation of initial background task types:
    *   Single Scene Content -> Summary Generation (Async Option)
    *   Single Summary -> Scene Content Generation (Async Option)
    *   Batch Scene Content -> Summary Generation (for a chapter or specified range)
    *   Batch Summary -> Scene Content Generation (for a chapter or specified range)
*   Basic error handling and configurable retry mechanism for transient errors within tasks.
*   Frontend UI components:
    *   Option (e.g., button/checkbox) on relevant AI generation interfaces to choose "Run in Background".
    *   A dedicated "Tasks" or "Background Jobs" view/panel listing user's tasks, showing status (Queued, Running, Completed, Failed, Cancelled), progress (if available), timestamps, and actions (Cancel, View/Apply Result).
*   Association of tasks with the initiating user.

**Out of Scope (Version 1.0):**

*   Complex task dependency management or workflow orchestration (e.g., multi-step tasks triggered sequentially).
*   Advanced task prioritization or queue management.
*   Real-time push notifications for task completion (Polling mechanism is acceptable for v1.0).
*   Guaranteed task resumability from the exact interruption point for *all* task types (Best-effort or resumability for specific batch tasks may be considered).
*   Administrator-level task monitoring or management interface.
*   Detailed cost tracking per task.

**5. User Stories**

*   **As a writer,** when generating a summary for a very long scene, I want to run this process in the background **so that** I can continue writing or editing other parts of my novel without waiting for the generation to finish.
*   **As a writer,** I want to select multiple scene outlines in a chapter and initiate AI generation for all of them as a single background task **so that** I don't have to trigger them one by one and wait each time.
*   **As a writer,** I want to access a list of my background tasks **so that** I can see which ones are running, which have finished, and which might have failed.
*   **As a writer,** I want to see an estimated progress (e.g., percentage, items processed) for my running background tasks **so that** I have an idea of how long they might take.
*   **As a writer,** if I start a background task by mistake or no longer need it, I want to be able to attempt to cancel it **so that** system resources aren't wasted.
*   **As a writer,** when a background task (like generating a scene) completes successfully, I want to easily view the generated content and have an option to insert/apply it to the relevant part of my novel **so that** I can utilize the result.
*   **As a writer,** if a background task fails, I want to see a clear error message **so that** I understand what went wrong and can decide whether to retry.
*   **As a developer,** I need a clear framework for adding new types of background tasks **so that** the system is extensible for future features.

**6. Functional Requirements**

**6.1 Backend (`AINovalServer`)**

*   **FR-B-01: Task Definition:** Provide a mechanism (e.g., interfaces, base classes) to define new background task types, including their specific input parameters, execution logic, and how they report progress/results.
*   **FR-B-02: Task Interface:** Define a standard `BackgroundTask` interface/abstract class with methods like `execute()`, `cancel()`, `getStatus()`, `getProgress()`, `getResult()`.
*   **FR-B-03: Task Persistence:** Store task information (ID, User ID, Type, Status, Parameters, Progress, Result/Error, Timestamps) reliably in a dedicated MongoDB collection (e.g., `background_tasks`).
*   **FR-B-04: Task Queueing & Execution:** Implement a mechanism to receive task requests via API, persist them, and manage their execution (e.g., using a dedicated `ExecutorService` configured with virtual threads).
*   **FR-B-05: Status & Progress Updates:** Task execution logic must update the task's status (QUEUED, RUNNING, COMPLETED, FAILED, CANCELLED) and progress (e.g., percentage, step description) in the persistent store.
*   **FR-B-06: Result Storage:** Successfully completed tasks must store their results (e.g., generated text, list of generated IDs) in the persistent store, associated with the task ID.
*   **FR-B-07: Error Handling & Logging:** Failed tasks must store relevant error information. Implement configurable retries for transient errors (e.g., network issues during AI calls). Log key task lifecycle events.
*   **FR-B-08: Concurrency Control:** Implement basic concurrency limits to prevent overwhelming system resources or external API rate limits (configurable).
*   **FR-B-09: Task Cancellation:** Provide a mechanism to flag a task for cancellation. The running task logic should periodically check this flag and attempt to terminate gracefully (best-effort).
*   **FR-B-10: API Endpoints:** Implement RESTful APIs (details in Section 9).
*   **FR-B-11: User Association:** Ensure all tasks are associated with the `userId` of the requestor and API endpoints enforce ownership checks.
*   **FR-B-12: Integration with Services:** Background task logic should utilize existing services (`AIService`, `NovelService`, `SceneService`, etc.) for core operations like AI calls and data access.

**6.2 Frontend (`AINoval`)**

*   **FR-F-01: Async Trigger:** Provide a clear UI element (e.g., "Run in Background" button/toggle) alongside existing AI generation triggers where applicable.
*   **FR-F-02: Task Submission:** Clicking the async trigger should call the appropriate backend API to create a background task. Provide feedback to the user that the task has been submitted (e.g., toast notification with Task ID).
*   **FR-F-03: Task List View:** Implement a dedicated section/panel/page accessible to the user (e.g., "Tasks", "Jobs") that lists their background tasks.
*   **FR-F-04: Task List Display:** The list should display key information for each task: Task ID (or user-friendly name/description), Type, Status, Progress (visual bar if possible), Submitted Time, Last Updated Time.
*   **FR-F-05: Task List Filtering/Sorting:** Allow basic filtering (e.g., by status) and sorting (e.g., by submission time).
*   **FR-F-06: Task Status Updates:** The task list should periodically poll the backend API (or use SSE/WebSockets if implemented later) to update task statuses and progress.
*   **FR-F-07: View Task Details/Results:** Allow users to click on a completed task to view its results (e.g., in a modal or separate view). Failed tasks should display error information.
*   **FR-F-08: Apply Task Results:** For completed tasks with actionable results (e.g., generated text), provide a button/action (e.g., "Apply", "Copy", "Insert into Editor") to utilize the result. The exact action depends on the task type.
*   **FR-F-09: Cancel Task Action:** Provide a "Cancel" button for tasks in QUEUED or RUNNING state, which calls the backend cancellation API.

**7. Non-Functional Requirements**

*   **NFR-01: Reliability:** Task states must be reliably persisted. The system should handle application restarts gracefully (e.g., identify tasks that were RUNNING and potentially mark them as FAILED or INTERRUPTED).
*   **NFR-02: Scalability:** The system should handle a reasonable number of concurrent users submitting and running tasks without significant degradation (specific targets TBD based on expected load). Concurrency limits must be configurable.
*   **NFR-03: Performance:** API endpoints for task management should respond quickly (<500ms P95 for list/status checks). Task execution time depends on the underlying operation but should not unduly impact other system functions.
*   **NFR-04: Maintainability:** Task definition and execution logic should be modular and easy to extend with new task types. Code should follow existing project conventions and be well-documented.
*   **NFR-05: Security:** All API endpoints must be authenticated and authorized. Users must only be able to access and manage their own tasks.
*   **NFR-06: Observability:** Log key events (task creation, status changes, errors, completion). Expose basic metrics (e.g., queue size, active tasks, error count) via Micrometer if possible.

**8. UI/UX Considerations**

*   **Clarity:** Clearly differentiate between synchronous ("Generate Now") and asynchronous ("Run in Background") actions.
*   **Feedback:** Provide immediate feedback upon task submission. Progress indicators in the task list are crucial for managing user expectations.
*   **Discoverability:** The "Tasks" section should be easily accessible (e.g., sidebar link, icon).
*   **Actionability:** Results of completed tasks should be easy to view and apply in the relevant context. Error messages should be user-friendly.
*   **Consistency:** The task management UI should follow the overall design language of AINovalWriter.

**9. API Specification (High-Level)**

*   **`POST /api/tasks/{taskType}`**
    *   **Description:** Submits a new background task. Can also be triggered via query param on existing endpoints (e.g., `POST /api/ai/generate-summary?async=true`).
    *   **Request Body:** Contains task-specific parameters (e.g., `sceneId`, `novelId`, `range`).
    *   **Response:** `202 Accepted` with `{ "taskId": "..." }`.
*   **`GET /api/tasks`**
    *   **Description:** Retrieves a list of the current user's background tasks.
    *   **Query Params:** `status`, `page`, `size`, `sortBy`, `sortDir`.
    *   **Response:** `200 OK` with a paginated list of task summaries (ID, Type, Status, Progress, CreatedAt, UpdatedAt).
*   **`GET /api/tasks/{taskId}`**
    *   **Description:** Retrieves the detailed status and result (if available) of a specific task.
    *   **Response:** `200 OK` with full task details, including `result` (if COMPLETED) or `errorInfo` (if FAILED). `404 Not Found` if task doesn't exist or doesn't belong to the user.
*   **`DELETE /api/tasks/{taskId}`**
    *   **Description:** Requests cancellation of a running or queued task.
    *   **Response:** `202 Accepted` (indicates request received, not guaranteed cancellation) or `404 Not Found` or `409 Conflict` (if already completed/failed).
*   **`POST /api/tasks/{taskId}/apply`** (Alternatively, result retrieval might be sufficient via `GET /api/tasks/{taskId}` and apply logic handled solely by frontend)
    *   **Description:** Signals the backend to apply the result of a completed task (if backend action is needed). *This endpoint needs further design based on specific task types.* Or, simply used by frontend after getting results via GET.
    *   **Response:** `200 OK` or `409 Conflict` (if task not completed or result already applied).

**10. Data Model (MongoDB `background_tasks` Collection)**

```json
{
  "_id": "<ObjectId>", // Task ID
  "userId": "<UserId>", // ID of the user who submitted the task
  "taskType": "string", // e.g., "GENERATE_SUMMARY", "BATCH_GENERATE_SCENES"
  "status": "string", // ENUM: QUEUED, RUNNING, COMPLETED, FAILED, CANCELLED
  "parameters": { ... }, // Task-specific input parameters
  "progress": {
    "percentage": "number", // 0-100
    "message": "string" // e.g., "Processed 5/10 chapters"
  },
  "result": { ... }, // Task-specific output (only when COMPLETED)
  "errorInfo": { // Only when FAILED
    "message": "string",
    "details": "string", // Optional stack trace or more info
    "retryCount": "number"
  },
  "createdAt": "<ISODate>",
  "updatedAt": "<ISODate>",
  "startedAt": "<ISODate>", // Optional: Time execution started
  "completedAt": "<ISODate>" // Optional: Time execution finished (completed or failed)
}
```

**11. Open Questions & Future Considerations**

*   Final decision on real-time progress updates (Polling vs. SSE/WebSockets for v1.0 vs. v1.x).
*   Detailed design for task resumability for batch jobs.
*   Specific implementation strategy for concurrency limiting.
*   Define precise retry policies (backoff strategy, max attempts) per task type or globally.
*   Need for task prioritization in future versions.
*   Design for complex workflow/DAG tasks.
*   Explore using a dedicated job scheduling library (like Quartz) if the custom `ExecutorService` approach becomes too complex.

**12. Success Metrics**

*   **User Adoption:** Percentage of eligible AI operations executed via the background task system.
*   **Task Success Rate:** Percentage of submitted background tasks that complete successfully.
*   **Reduction in UI Blocking:** User feedback and potentially client-side metrics indicating fewer instances of UI unresponsiveness during AI operations.
*   **User Satisfaction:** Surveys or feedback forms regarding the usefulness and usability of the background task feature.
*   **Error Rate:** Monitor failure rates for tasks, aiming to decrease failures caused by transient issues over time.

**13. Document History**

| Version | Date       | Author       | Changes                                      |
| :------ | :--------- | :----------- | :------------------------------------------- |
| 1.0     | 2024-07-27 | AI Assistant | Initial draft based on discussion points. |
