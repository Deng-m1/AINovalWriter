# 前端需求文档: AINoval 后台任务系统集成

**Version:** 1.0
**Date:** 2024-07-27
**Author:** AI Assistant (acting as Tech Lead)
**Based on PRD:** 需求文档/后台任务系统需求文档.md (Version 1.0)
**Backend API Spec:** Refer to PRD Section 9 & 后台任务系统后端任务分解.md

## 1. 概述与目标

**1.1 概述**

本文档为 `AINoval` Flutter 应用的前端开发团队提供实现后台任务系统集成的详细需求。该系统允许用户将耗时操作（如 AI 内容生成、批量处理）作为后台任务执行，避免阻塞 UI，并提供类似“下载管理器”的界面来跟踪和管理这些任务。现有的同步 AI 操作将**继续保留**，后台任务作为补充选项提供给用户。

**1.2 前端目标**

*   **提供异步选项:** 在相关的 AI 功能界面（如编辑器、AI 面板）上，为用户提供明确的“后台执行”选项。
*   **任务管理界面:** 实现一个专门的视图/页面，让用户可以查看、跟踪和管理他们提交的后台任务。
*   **状态与进度反馈:** 清晰地向用户展示任务的实时状态（排队、运行中、完成、失败、已取消）和进度（如果可用）。
*   **结果处理:** 允许用户方便地查看成功任务的结果，并将结果应用到应用程序的相关部分（如编辑器）。
*   **错误呈现:** 向用户清晰地展示失败任务的错误信息。
*   **无缝集成:** 将后台任务功能自然地融入现有 `AINoval` 应用的工作流和 UI 风格中。

## 2. 范围 (Frontend Scope - V1.0)

*   **UI 修改:** 在现有 AI 功能触发点（如下文详述）添加“后台执行”按钮/选项。
*   **新视图:** 创建一个新的“后台任务”视图/页面。
*   **状态管理:**
    *   创建新的 Bloc (`BackgroundTaskBloc`) 来管理任务列表、状态获取和用户操作。
    *   可能需要与现有 Bloc (如 `EditorBloc`, `ChatBloc`) 交互，以触发任务或应用结果。
*   **API 客户端:** 更新或创建 API service/repository 以调用后端 `/api/tasks` 相关端点。
*   **数据模型:** 定义 Dart 数据模型以表示后台任务及其相关信息。
*   **用户反馈:** 实现 Toast 通知、加载指示器、进度条等反馈机制。

## 3. 用户故事 (Frontend Perspective)

*   **As a writer using the AINoval app,** when I trigger an AI summary generation for a long scene, I want to see a "Run in Background" option next to the "Generate Now" button **so that** I can choose not to wait and continue editing.
*   **As a writer,** after submitting a background task, I want to see a quick confirmation (like a toast message) saying "Task submitted" **so that** I know the process has started.
*   **As a writer,** I want to find a "Background Tasks" (或 “后台任务”) item in the main navigation (e.g., sidebar) **so that** I can easily access the list of my tasks.
*   **As a writer,** on the "Background Tasks" screen, I want to see a list of my tasks with their type (e.g., "Generate Summary"), status (e.g., "Running", "Completed", with icons/colors), and a progress bar **so that** I can quickly understand their state.
*   **As a writer,** I want to be able to tap a "Cancel" button next to a "Running" or "Queued" task **so that** I can stop tasks I no longer need.
*   **As a writer,** when a "Generate Scene" task is "Completed", I want to tap on it to see the generated text in a dialog/panel and have an "Insert into Editor" button **so that** I can easily use the result.
*   **As a writer,** if a task shows "Failed", I want to tap on it to see an error message **so that** I know why it failed.

## 4. 详细功能需求 (Frontend Implementation)

**4.1 触发后台任务**

*   **FRF-Trigger-01: UI Element Placement:**
    *   **Editor:** For actions like generating summary/scene from selected text or current scene context, add a "Run in Background" (`后台运行`) button or icon alongside the existing synchronous "Generate" (`生成`) button within relevant toolbars (e.g., `EditorToolbar`, `SelectionToolbar`) or context menus.
    *   **AI Panels:** In dedicated AI generation panels (e.g., `AIGenerationPanel`, `AISceneGenerationSidePanel`), provide a similar "Run in Background" option near the primary action button.
    *   **Batch Actions:** For future batch processing UI (e.g., selecting multiple chapters/scenes), the primary action might default to background execution or offer it prominently. (V1 focuses on single item async triggers first).
*   **FRF-Trigger-02: Interaction Flow:**
    *   User clicks "Run in Background".
    *   Display a subtle loading indicator near the button.
    *   Call the appropriate backend API (`POST /api/tasks/{taskType}` or existing API with `?async=true`).
    *   On successful API response (`202 Accepted`), hide the loading indicator and show a short-lived Toast/Snackbar message (e.g., "任务已提交到后台 / Task submitted to background"). Include the Task ID if helpful for debugging.
    *   Handle API errors during submission (e.g., show an error toast).
*   **FRF-Trigger-03: Supported Task Types (Initial):**
    *   Single Scene Content -> Summary Generation.
    *   Single Summary -> Scene Content Generation.
    *   (Placeholders for future Batch Scene <-> Summary tasks).

**4.2 后台任务管理视图 (`BackgroundTaskListView`)**

*   **FRF-View-01: Access:** Add a new navigation item in the main application sidebar/drawer labeled "后台任务" (Background Tasks). Clicking it navigates to this new view.
*   **FRF-View-02: Layout:** Display a list of tasks using `ListView.builder` for efficient rendering. Include a "Refresh" (`刷新`) button (e.g., in the AppBar). Consider pull-to-refresh functionality.
*   **FRF-View-03: Task Item Display (`TaskListItem` Widget):** Each item in the list should display:
    *   **Task Type:** User-friendly name (e.g., "生成摘要", "生成场景", "批量生成摘要"). Map from `taskType` string.
    *   **Status:** Display the status (`QUEUED`, `RUNNING`, `COMPLETED`, `FAILED`, `CANCELLED`) using distinct icons and/or color coding (e.g., Blue for Running, Green for Completed, Red for Failed, Grey for Cancelled/Queued).
    *   **Progress:** If `progress.percentage` is available and the task is `RUNNING`, display a `LinearProgressIndicator` or similar visual bar. Show `progress.message` text if available (e.g., "Processed 5/10 chapters").
    *   **Timestamps:** Show `createdAt` or `updatedAt` (formatted nicely, e.g., "Submitted 5 minutes ago", "Updated just now").
    *   **Actions:** Display relevant action buttons based on status (See FRF-Action-01).
*   **FRF-View-04: Data Loading & Updates:**
    *   On view load, trigger an event in `BackgroundTaskBloc` to fetch the first page of tasks (`GET /api/tasks`).
    *   Implement pagination (load more tasks when scrolling to the bottom).
    *   Implement polling: Periodically trigger a refresh event in the Bloc (e.g., every 10-15 seconds when the view is active) to call `GET /api/tasks` and update the list. Handle errors during polling gracefully (e.g., show a small error indicator, don't block the entire list).
*   **FRF-View-05: Filtering/Sorting (Optional V1, Recommended V1.x):** Add controls (e.g., dropdowns in AppBar) to filter tasks by status and sort by date. Update the API call parameters accordingly.
*   **FRF-View-06: Empty State:** If the user has no tasks, display a user-friendly message (e.g., "您还没有后台任务 / You have no background tasks yet").
*   **FRF-View-07: Loading/Error States:** Display appropriate loading indicators while fetching/refreshing tasks. Display a clear error message with a retry option if the initial task list fetch fails.

**4.3 任务操作 (`TaskListItem` Actions)**

*   **FRF-Action-01: Conditional Actions:**
    *   If Status is `QUEUED` or `RUNNING`: Show a "Cancel" (`取消`) button/icon.
    *   If Status is `COMPLETED`: Show a "View Result" (`查看结果`) button/icon.
    *   If Status is `FAILED`: Show a "View Error" (`查看错误`) button/icon.
*   **FRF-Action-02: Cancel Task:**
    *   Clicking "Cancel" triggers `CancelTask(taskId)` event in `BackgroundTaskBloc`.
    *   Bloc calls `DELETE /api/tasks/{taskId}`.
    *   Visually update the task item immediately (e.g., disable button, show "Cancelling..." text, then update status to `CANCELLED` upon next refresh or specific feedback). Handle API errors during cancellation.
*   **FRF-Action-03: View Result / Error:**
    *   Clicking "View Result" or "View Error" triggers an event (e.g., `ShowTaskDetails(taskId)`) or directly displays a modal dialog (`showDialog`).
    *   **Result Dialog:** Display the task's `result` data in a readable format. For generated text, show the text possibly with syntax highlighting or formatting. Include an "Apply" (`应用`) or "Copy" (`复制`) button if applicable (See FRF-Apply-01).
    *   **Error Dialog:** Display the `errorInfo.message` and potentially `errorInfo.details` clearly.
*   **FRF-Action-04: Apply Task Result:**
    *   **Location:** Inside the "View Result" dialog for relevant task types (e.g., "生成场景", "生成摘要").
    *   **Interaction:** Clicking "Apply" triggers `ApplyTaskResult(taskId, taskData)` event in `BackgroundTaskBloc`.
    *   **Logic (Coordination Needed):**
        *   `BackgroundTaskBloc` needs to determine the *context* where the result should be applied (this might need to be stored with the task parameters or inferred).
        *   It will likely need to trigger an event in another Bloc. Examples:
            *   For "Generate Scene": Trigger `InsertGeneratedContent(content)` in `EditorBloc` if the task originated from the editor context.
            *   For "Generate Summary": Trigger `UpdateSceneSummary(sceneId, summary)` in `EditorBloc` or potentially `NovelStructureBloc`.
        *   Provide user feedback upon successful application (e.g., close dialog, show toast "结果已应用 / Result applied"). Handle errors during application.

## 5. 状态管理 (Bloc)

*   **FRF-Bloc-01: New `BackgroundTaskBloc`:**
    *   **Purpose:** Manage the state of the background task list and interactions.
    *   **Events:**
        *   `LoadTasksRequested(bool refresh = false)`
        *   `LoadMoreTasksRequested`
        *   `CancelTaskRequested(String taskId)`
        *   `ApplyTaskResultRequested(String taskId, BackgroundTask task)` (Task object needed for context/result)
        *   `_TaskPollingTick` (Internal event for periodic refresh)
        *   `_TasksUpdated(List<BackgroundTask> tasks, PaginationInfo pagination)` (Internal event on successful API fetch)
    *   **States:**
        *   `TasksInitial`
        *   `TasksLoadInProgress`
        *   `TasksLoadSuccess(List<BackgroundTask> tasks, bool hasReachedMax, PaginationInfo pagination)`
        *   `TasksLoadFailure(String errorMessage)`
        *   (Potentially specific states for cancellation/application confirmation, or handle via flags within `TasksLoadSuccess`)
    *   **Functionality:** Handles API calls via a dedicated repository/service, manages pagination state, starts/stops polling timer based on view lifecycle.
*   **FRF-Bloc-02: Bloc Interaction:**
    *   **Triggering:** Existing Blocs (e.g., `EditorBloc`) call the `TaskApiService` directly to submit tasks. No direct dependency on `BackgroundTaskBloc` for *submission*.
    *   **Applying Results:** `BackgroundTaskBloc` needs to communicate with other Blocs (e.g., `EditorBloc`) to apply results. This can be done via:
        *   Direct Bloc-to-Bloc communication (less preferred due to coupling).
        *   A shared service or repository that Blocs can listen to (better).
        *   Having the UI widget listen to `BackgroundTaskBloc` state changes (e.g., `ApplySuccess`) and then dispatching an event to the relevant context Bloc (`EditorBloc.add(...)`). This is often the cleanest approach.

## 6. API Interaction (Frontend Service/Repository)

*   **FRF-API-01: `TaskApiService` / Repository:** Create or update a service class responsible for all `/api/tasks` interactions.
*   **FRF-API-02: Methods:** Implement methods corresponding to backend endpoints:
    *   `submitTask(taskType, parameters)` -> `taskId`
    *   `getTasks(status, page, size)` -> `PaginatedResponse<BackgroundTask>`
    *   `getTaskDetails(taskId)` -> `BackgroundTask`
    *   `cancelTask(taskId)` -> `void`
*   **FRF-API-03: Error Handling:** Implement robust error handling – catch exceptions, parse backend error responses (`ErrorResponse` DTO), return meaningful error objects or throw specific exceptions for Bloc to handle.
*   **FRF-API-04: Authentication:** Ensure all API calls include the necessary authentication token (handled by existing API client infrastructure).

## 7. 数据模型 (Frontend Dart Models)

*   **FRF-Model-01: `BackgroundTask` Class:**
    *   Fields matching backend model (Section 10 of PRD), using appropriate Dart types (`String`, `DateTime`, `enum TaskStatus`, `Map<String, dynamic>` or specific classes for `parameters`, `progress`, `result`, `errorInfo`).
    *   Include `fromJson` factory constructor.
*   **FRF-Model-02: `TaskStatus` Enum:** Define `enum TaskStatus { QUEUED, RUNNING, COMPLETED, FAILED, CANCELLED }`.
*   **FRF-Model-03: Helper Models:** Define classes for `TaskProgress`, `TaskResult`, `TaskErrorInfo` if needed for better type safety than `Map`.
*   **FRF-Model-04: `PaginatedResponse`:** Use a generic wrapper class if not already existing for paginated API responses.

## 8. UI/UX Considerations

*   **Consistency:** Match the existing AINoval visual style (fonts, colors, spacing, components).
*   **Clarity:** Use clear labels, icons, and color coding for task statuses. Make the "Run in Background" option easily distinguishable but not intrusive.
*   **Feedback:** Provide immediate feedback for actions (submission, cancellation). Use progress bars effectively.
*   **Responsiveness:** Ensure the Task List view performs well even with many tasks. Polling should not degrade perceived performance.

## 9. 非功能性需求 (Frontend)

*   **Performance:** Task list scrolling should be smooth. API polling should be efficient and stop when the view is inactive.
*   **Error Handling:** Gracefully handle API errors during task submission, list fetching, and polling. Provide clear, user-friendly error messages.
*   **State Preservation:** Consider preserving scroll position or filter/sort settings in the Task List view when navigating away and back (optional enhancement).

## 10. Open Questions & Future Considerations

*   Exact UI placement for "Run in Background" triggers requires design review.
*   Polling interval fine-tuning (10-15s is a starting point).
*   Consider implementing real-time updates via WebSockets/SSE in V2 for better UX than polling.
*   Detailed design for the "Apply Result" workflow for different task types and contexts.
*   How to best represent batch task progress? (Overall percentage vs. items processed).

## 11. Document History

| Version | Date       | Author             | Changes                                                                 |
| :------ | :--------- | :----------------- | :---------------------------------------------------------------------- |
| 1.0     | 2024-07-27 | AI Assistant       | Initial draft based on PRD and Backend Task Decomposition.         |
