# AINoval 前端后台任务系统 - 任务分解与组件选型

**Version:** 1.0
**Date:** 2024-07-27
**Author:** AI Assistant (acting as FE Dev)
**Based on Frontend Requirements:** 需求文档/前端后台任务系统需求文档.md (Version 1.0)

## 1. Flutter 组件与包调研 (Component & Package Research)

根据需求文档和当前 AINoval 项目可能已有的依赖 (`flutter_bloc`, `dio`, 标准 Flutter Widgets)，初步选型如下：

*   **“后台运行”按钮 (FRF-Trigger-01):**
    *   使用标准 Flutter 按钮：
        *   `TextButton` 或 `OutlinedButton` 配合图标 (`Icons.cloud_upload_outlined` 或类似) 放置于现有“生成”按钮旁。
        *   在某些特定场景下，如果同步/异步切换逻辑清晰，也可考虑 `ToggleButtons`，但独立按钮可能更直观。
    *   加载指示器：使用小尺寸的 `CircularProgressIndicator`，在提交 API 时于按钮附近条件性显示。
*   **Toast/Snackbar 反馈 (FRF-Trigger-02):**
    *   使用 Flutter 内建的 `ScaffoldMessenger.of(context).showSnackBar()` 配合 `SnackBar`。
    *   如果项目未统一使用，也可引入 `fluttertoast` 等包，但 `SnackBar` 是内置方案。
*   **任务列表视图 (`BackgroundTaskListView` - FRF-View-01, 02):**
    *   新建屏幕 Widget (`lib/screens/tasks/task_list_screen.dart`)。
    *   使用 `Scaffold` 包含 `AppBar` (含标题及可能的刷新/过滤按钮)。
    *   使用 `BlocBuilder<BackgroundTaskBloc, BackgroundTaskState>` 监听状态变化。
    *   使用 `ListView.builder` 高效展示任务列表。
    *   使用 `RefreshIndicator` 包裹 `ListView` 实现下拉刷新。
    *   通过 `ScrollController` 监听滚动位置实现分页加载 (触发 `LoadMoreTasksRequested` 事件)。
*   **任务列表项 (`TaskListItem` Widget - FRF-View-03):**
    *   新建专用 Widget (`lib/screens/tasks/widgets/task_list_item.dart`)。
    *   以 `ListTile` 作为基础结构。
    *   使用 `Row` 和 `Column` 进行内部布局。
    *   使用 `Text` 显示任务类型、状态信息、时间戳。
    *   使用 `Icon` (如 `Icons.hourglass_empty`, `Icons.directions_run`, `Icons.check_circle`, `Icons.error`, `Icons.cancel`) 及 `Color` 表示状态。
    *   当状态为 `RUNNING` 时，使用 `LinearProgressIndicator` 显示 `progress.percentage`。
    *   使用 `Row` 包含 `IconButton` 或 `TextButton` 实现条件性操作按钮 (取消、查看结果/错误)。
*   **结果/错误对话框 (FRF-Action-03):**
    *   使用标准的 `showDialog()` 函数展示 `AlertDialog`。
    *   内容区：使用 `Text` 显示结果或错误信息。对长文本结果考虑使用 `SingleChildScrollView`。
    *   操作区：使用 `TextButton` 实现“关闭”、“复制”、“应用”按钮。
*   **状态管理 (FRF-Bloc-01):**
    *   使用 `flutter_bloc` 包 (应已是项目依赖)。新建 `BackgroundTaskBloc`。
*   **API 客户端 (FRF-API-01):**
    *   使用 `dio` 包 (应已是项目依赖)。更新现有 API 服务层或新建 `TaskApiService`。
*   **数据模型 (FRF-Model-01):**
    *   使用普通 Dart 类。如果项目已使用 `freezed` 或 `json_serializable`，可沿用以减少模板代码 (`fromJson`)。

**结论:** V1.0 功能主要依赖 Flutter 内建 Widgets 和项目已有的 `flutter_bloc`、`dio` 包即可实现，无需引入新的复杂 UI 库。

## 2. 前端任务分解

根据项目结构 (`lib/models`, `lib/services`, `lib/blocs`, `lib/screens`) 进行任务分解：

**阶段 1: 基础与数据模型**

*   **[FE-Task-Data-01] 定义 Dart 模型:**
    *   任务: 在 `lib/models/task/` 下创建 `BackgroundTask`, `TaskStatus`, `TaskProgress`, `TaskResult`, `TaskErrorInfo` Dart 类。
    *   要求: 实现 `fromJson` 构造函数。
    *   关联: FRF-Model-01, 02, 03
*   **[FE-Task-API-01] 更新/创建 API 服务:**
    *   任务: 在 `lib/services/api_service/` 或 `lib/repositories/` 下添加 `TaskApiService` 或扩展现有服务。
    *   要求: 实现 `submitTask`, `getTasks` (处理分页), `getTaskDetails`, `cancelTask` 方法。集成 `dio`，处理认证和错误。
    *   关联: FRF-API-01, 02, 03, 04

**阶段 2: 状态管理**

*   **[FE-Task-Bloc-01] 创建 `BackgroundTaskBloc`:**
    *   任务: 在 `lib/blocs/task/` 下创建 Bloc, Event, State 文件。
    *   要求: 定义事件和状态。注入 `TaskApiService`。实现任务获取、分页、加载/错误状态管理逻辑。
    *   关联: FRF-Bloc-01
*   **[FE-Task-Bloc-02] 实现任务轮询:**
    *   任务: 在 `BackgroundTaskBloc` 或视图中实现 `Timer.periodic`，在视图激活时定时分发刷新事件。
    *   要求: 确保 Timer 在视图销毁时被取消。
    *   关联: FRF-View-04

**阶段 3: UI 实现 - 任务列表**

*   **[FE-Task-Screen-01] 创建 `TaskListScreen`:**
    *   任务: 在 `lib/screens/tasks/task_list_screen.dart` 创建主屏幕 Widget。
    *   要求: 设置 `Scaffold`, `AppBar`。集成 `BlocProvider`。使用 `BlocBuilder` 渲染 UI。实现基础布局和空/错误状态。
    *   关联: FRF-View-01, 06, 07
*   **[FE-Task-Widget-01] 创建 `TaskListItem` Widget:**
    *   任务: 在 `lib/screens/tasks/widgets/task_list_item.dart` 创建列表项 Widget。
    *   要求: 实现布局。根据 `BackgroundTask` 模型显示数据和进度条。实现条件化操作按钮。按钮点击连接到 Bloc 事件。
    *   关联: FRF-View-03, FRF-Action-01, 02, 03
*   **[FE-Task-Screen-02] 实现 `ListView` 与分页:**
    *   任务: 在 `TaskListScreen` 中集成 `TaskListItem` 和 `ListView.builder`。
    *   要求: 添加 `ScrollController` 实现上拉加载更多。使用 `RefreshIndicator` 实现下拉刷新。
    *   关联: FRF-View-02, 04

**阶段 4: UI 实现 - 触发与集成**

*   **[FE-Task-UI-01] 添加“后台运行”按钮:**
    *   任务: 修改编辑器工具栏、AI 面板等相关 UI (`lib/screens/editor/widgets/`, `lib/screens/chat/widgets/`)。
    *   要求: 添加按钮。点击直接调用 `TaskApiService.submitTask`。显示加载状态和 `SnackBar` 反馈。
    *   关联: FRF-Trigger-01, 02
*   **[FE-Task-Nav-01] 添加导航入口:**
    *   任务: 在主导航（如 `Drawer`）中添加入口指向 `TaskListScreen`。
    *   关联: FRF-View-01
*   **[FE-Task-UI-02] 实现结果/错误对话框:**
    *   任务: 在 `lib/ui/dialogs/` 创建帮助函数或 Widgets。
    *   要求: 使用 `showDialog` 和 `AlertDialog` 显示信息。包含 “复制” 和条件性 “应用” 按钮。
    *   关联: FRF-Action-03

**阶段 5: 应用结果与收尾**

*   **[FE-Task-Apply-01] 实现“应用结果”逻辑:**
    *   任务: 连接“应用”按钮到 `BackgroundTaskBloc` 的 `ApplyTaskResultRequested` 事件。
    *   要求: 在 Bloc 中实现与 `EditorBloc` 等其他 Bloc 的交互逻辑，传递结果。更新目标 Bloc 以处理新事件。
    *   关联: FRF-Action-04, FRF-Bloc-02
*   **[FE-Task-Test-01] 单元与 Widget 测试:**
    *   任务: 为 `BackgroundTaskBloc` 编写单元测试 (`bloc_test`)。为 `TaskListScreen` 和 `TaskListItem` 编写 Widget 测试。
*   **[FE-Task-Int-01] 集成与手动测试:**
    *   任务: 测试完整流程：触发 -> 列表查看 -> 进度 -> 结果/错误 -> 应用。测试取消、错误处理、分页刷新。
