# 提示词模板生成需求规格说明

## 1. 需求概述

为提示词管理面板添加一个新功能，允许用户在添加模板时，通过AI辅助生成或规范化提示词内容。该功能将使用用户自己配置的AI模型，类似于现有的场景和摘要生成功能。通过精心设计的UI/UX，确保整个体验流畅、专业且具有高级感，提升用户对产品的满意度。

**重要说明**：模板管理系统将区分为**公共模板**和**用户私有模板**两种类型。用户只能编辑和优化自己的私有模板，公共模板仅供查看和复制。

## 2. 用户场景

### 2.1 模板类型区分

1. **公共模板**：由系统或管理员提供的标准模板，所有用户可见但不可直接编辑
2. **用户私有模板**：用户自己创建或从公共模板复制修改而来的个人模板

### 2.2 使用流程

用户在"提示词设置"的模板库中：
1. 可以浏览所有公共模板和自己的私有模板
2. 公共模板可以查看、使用和复制为私有模板，但不能直接编辑
3. 对于私有模板，用户可以:
   - 创建新模板时输入简单的描述或草稿
   - 点击"AI优化"按钮
   - 选择优化风格和参数
   - 系统调用用户已配置的AI模型，生成更为规范和结构化的提示词
   - 用户可以接受生成结果，或继续手动编辑
4. 用户可以将自己优化后满意的私有模板标记为"收藏"，方便快速访问

## 3. 前端需求

### 3.1 UI组件设计与拆分

为了提供更加模块化、可维护且高级的用户体验，将UI组件进行如下拆分：

1. **PromptTemplateLibrary**: 模板库主视图
   - 分区显示公共模板和私有模板
   - 使用视觉差异区分两种模板类型
   - 提供搜索、筛选和排序功能
   - 公共模板显示"复制"按钮，私有模板显示"编辑"按钮

2. **PromptEditorPanel**: 核心编辑面板（仅用于私有模板）
   - 支持富文本编辑、语法高亮
   - 词数统计、字符数限制提示
   - 自动保存功能
   - 支持标签化的变量插入
   - 清晰显示"这是您的私有模板"标识

3. **AIAssistToolbar**: AI辅助工具栏（仅用于私有模板）
   - 优化按钮（带有微妙的动画效果）
   - 风格选择下拉菜单（专业、创意、简洁等）
   - 优化强度滑块（保留原始内容程度）

4. **OptimizationResultView**: 优化结果视图
   - 分屏对比视图（原始vs优化后）
   - 变更高亮显示
   - 接受/拒绝/部分接受控制

5. **ProcessingIndicator**: 处理状态指示器
   - 优雅的加载动画
   - 进度提示（对于流式响应）
   - 可取消操作

6. **TemplatePermissionIndicator**: 模板权限指示器
   - 清晰显示当前模板的类型（公共/私有）
   - 对公共模板显示"仅供查看"提示
   - 提供一键复制公共模板为私有模板的功能

### 3.2 UI/UX设计原则

为确保高级感和专业体验：

1. **色彩方案**:
   - 使用渐变色调而非平面色
   - 对关键功能采用强调色
   - 轻微的暗色系背景，让内容更突出
   - 通过色彩区分公共模板（如蓝色系）和私有模板（如绿色系）

2. **动效设计**:
   - 平滑过渡动画（300-500ms）
   - 微妙的悬停效果和反馈
   - 进度指示使用波浪或脉冲动画
   - 权限相关操作有明确的反馈动效

3. **排版**:
   - 使用变量宽度字体提升可读性
   - 合理的行间距和段落间距
   - 编辑区内容具有适当的留白
   - 权限提示醒目但不突兀

4. **交互设计**:
   - 支持快捷键操作
   - 上下文感知的工具提示
   - 拖拽调整分屏比例
   - 触觉反馈（在支持的设备上）
   - 公共模板到私有模板的复制有明确引导

### 3.3 交互流程

#### 3.3.1 公共模板交互
1. 用户浏览公共模板库
2. 点击模板卡片查看详情
3. 可以点击"复制到我的模板"按钮，将公共模板复制为私有模板
4. 系统提示复制成功，并询问是否立即编辑

#### 3.3.2 私有模板交互
1. 用户创建或编辑私有模板
2. 点击"AI优化"按钮后，展开风格选择面板
3. 用户选择优化风格和强度
4. 显示精致的加载动画，同时保持UI的响应性
5. 当接收到流式响应时，实时更新对比视图
6. 完成后允许用户选择全部接受、拒绝或选择性接受特定段落
7. 提供一键恢复功能，返回到原始内容

### 3.4 具体实现

1. 重构`prompt_management_panel.dart`，将其拆分为多个组件文件:
   - `prompt_template_library.dart`（新增）
   - `prompt_editor_panel.dart`
   - `ai_assist_toolbar.dart`
   - `optimization_result_view.dart`
   - `processing_indicator.dart`
   - `template_permission_indicator.dart`（新增）

2. 实现状态管理，使用Provider或Bloc模式，确保权限控制逻辑清晰

3. 添加自适应布局，确保在不同屏幕尺寸下的良好体验

4. 实现流式响应处理，提供平滑的实时更新体验

5. 添加权限控制逻辑，确保用户只能编辑私有模板

## 4. 后端需求

### 4.1 数据模型扩展

扩展现有PromptTemplate模型，添加以下字段：
```json
{
  "isPublic": false,  // 是否为公共模板
  "authorId": "user_id",  // 作者ID（公共模板可为null或系统ID）
  "sourceTemplateId": "template_id",  // 源模板ID（如果是从公共模板复制的）
  "isVerified": false,  // 是否为官方验证模板
  "isFavorite": false   // 用户是否收藏（仅对私有模板有效）
}
```

### 4.2 API设计

#### 4.2.1 模板管理API

1. 获取模板列表（增加类型过滤）:
```
GET /api/users/me/prompts?type=public|private|all
```

2. 复制公共模板:
```
POST /api/users/me/prompts/copy/{templateId}
```

3. 优化私有模板:
```
POST /api/users/me/prompts/{templateId}/optimize
```

请求参数：
```json
{
  "content": "用户输入的提示词内容",
  "featureType": "提示词类型（如SCENE_TO_SUMMARY）",
  "templateName": "模板名称（可选）",
  "optimizationStyle": "优化风格（PROFESSIONAL/CREATIVE/CONCISE）",
  "preserveRatio": 0.5  // 保留原始内容的比例（0-1）
}
```

响应：
```json
{
  "optimizedContent": "优化后的提示词内容",
  "statistics": {
    "originalWordCount": 100,
    "optimizedWordCount": 120,
    "changeRatio": 0.2
  },
  "sections": [
    {
      "type": "unchanged",
      "content": "保持不变的部分"
    },
    {
      "type": "modified",
      "original": "原始内容",
      "optimized": "优化后内容"
    }
  ]
}
```

#### 4.2.2 流式API

```
POST /api/users/me/prompts/{templateId}/optimize-stream
```
使用SSE（Server-Sent Events）实现流式响应，包括部分结果和进度更新

### 4.3 权限控制

1. 添加权限检查中间件，确保:
   - 用户只能编辑、删除自己的私有模板
   - 公共模板对所有用户只读
   - 只有管理员可以创建或修改公共模板

2. 对所有模板修改API添加前置权限检查

### 4.4 服务层实现

1. 在`PromptService`中添加高级提示词优化接口和模板权限管理
2. 根据用户选择的风格，动态调整发送给AI模型的提示模板
3. 实现差异对比分析，用于前端显示变更
4. 添加统计分析功能，评估优化效果
5. 实现公共模板复制功能

### 4.5 具体实现

1. 在`PromptRepository`和`PromptRepositoryImpl`中添加扩展的方法：
   - 区分公共和私有模板的查询
   - 添加权限验证
   - 实现模板复制功能

2. 在`AIGenerationController`中添加新的高级API端点，确保权限控制

3. 在`NovelAIServiceImpl`中实现提示词优化的逻辑，支持不同风格和保留比例

## 5. 技术实现细节

### 5.1 前端实现

1. 改进的组件结构示例，添加模板权限控制：

```dart
// prompt_template_library.dart
class PromptTemplateLibrary extends StatefulWidget {
  @override
  Widget build(BuildContext context) {
    return DefaultTabController(
      length: 2,
      child: Column(
        children: [
          TabBar(
            tabs: [
              Tab(text: '公共模板'),
              Tab(text: '我的模板'),
            ],
          ),
          Expanded(
            child: TabBarView(
              children: [
                // 公共模板列表
                TemplateListView(
                  templates: _publicTemplates,
                  isPublic: true,
                  onCopy: _copyToPrivate,
                  onView: _viewTemplate,
                ),
                // 私有模板列表
                TemplateListView(
                  templates: _privateTemplates,
                  isPublic: false,
                  onEdit: _editTemplate,
                  onDelete: _deleteTemplate,
                  onToggleFavorite: _toggleFavorite,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// prompt_editor_panel.dart
class PromptEditorPanel extends StatefulWidget {
  final bool isPublic;
  
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        _buildHeader(),
        TemplatePermissionIndicator(
          isPublic: isPublic,
          onCopyToPrivate: isPublic ? _copyToPrivate : null,
        ),
        _buildEditorArea(),
        if (!isPublic) // 只有私有模板才显示AI辅助工具
          AIAssistToolbar(
            onOptimizeRequested: _handleOptimizeRequest,
            isProcessing: _isOptimizing,
            selectedStyle: _selectedStyle,
            onStyleChanged: _handleStyleChanged,
            preserveRatio: _preserveRatio,
            onRatioChanged: _handleRatioChanged,
          ),
        if (_isOptimizing)
          ProcessingIndicator(
            progress: _streamProgress,
            onCancel: _cancelOptimization,
          ),
        if (_optimizedContent != null)
          OptimizationResultView(
            original: _originalContent,
            optimized: _optimizedContent,
            sections: _diffSections,
            onAccept: _acceptOptimization,
            onReject: _rejectOptimization,
            onPartialAccept: _partiallyAcceptOptimization,
          ),
      ],
    );
  }
}
```

2. 模板权限指示器实现：

```dart
// template_permission_indicator.dart
class TemplatePermissionIndicator extends StatelessWidget {
  final bool isPublic;
  final VoidCallback? onCopyToPrivate;
  
  const TemplatePermissionIndicator({
    Key? key,
    required this.isPublic,
    this.onCopyToPrivate,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    
    return Container(
      padding: EdgeInsets.symmetric(vertical: 8, horizontal: 12),
      margin: EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(8),
        color: isPublic 
          ? theme.colorScheme.primary.withOpacity(0.1)
          : theme.colorScheme.secondary.withOpacity(0.1),
        border: Border.all(
          color: isPublic
            ? theme.colorScheme.primary.withOpacity(0.2)
            : theme.colorScheme.secondary.withOpacity(0.2),
        ),
      ),
      child: Row(
        children: [
          Icon(
            isPublic ? Icons.public : Icons.lock_outline,
            size: 16,
            color: isPublic
              ? theme.colorScheme.primary
              : theme.colorScheme.secondary,
          ),
          SizedBox(width: 8),
          Text(
            isPublic ? '公共模板（只读）' : '私有模板',
            style: TextStyle(
              fontSize: 13,
              fontWeight: FontWeight.w500,
              color: isPublic
                ? theme.colorScheme.primary
                : theme.colorScheme.secondary,
            ),
          ),
          Spacer(),
          if (isPublic && onCopyToPrivate != null)
            TextButton.icon(
              icon: Icon(Icons.copy, size: 14),
              label: Text('复制到我的模板'),
              style: TextButton.styleFrom(
                padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                minimumSize: Size(120, 30),
                tapTargetSize: MaterialTapTargetSize.shrinkWrap,
              ),
              onPressed: onCopyToPrivate,
            ),
        ],
      ),
    );
  }
}
```

### 5.2 后端实现

1. 在`PromptRepository`接口中添加模板类型和权限相关方法：
```dart
/**
 * 获取模板列表，支持公共/私有模板过滤
 * @param templateType 模板类型（PUBLIC/PRIVATE/ALL）
 * @return 模板列表
 */
Future<List<PromptTemplate>> getPromptTemplates({
  String templateType = 'ALL',
});

/**
 * 从公共模板复制创建私有模板
 * @param templateId 要复制的公共模板ID
 * @return 新创建的私有模板
 */
Future<PromptTemplate> copyFromPublicTemplate(String templateId);

/**
 * 检查模板的编辑权限
 * @param templateId 模板ID
 * @return 是否有编辑权限
 */
Future<bool> hasEditPermission(String templateId);
```

2. 在`NovelAIServiceImpl`中实现带权限检查的优化方法：
```java
@Override
public Mono<OptimizationResult> optimizePromptTemplate(String userId, String templateId, OptimizePromptRequest request) {
    // 首先检查模板权限
    return promptRepository.findTemplateById(templateId)
        .flatMap(template -> {
            // 验证是私有模板且属于当前用户
            if (template.isPublic() || !userId.equals(template.getAuthorId())) {
                return Mono.error(new AccessDeniedException("无法编辑公共模板或其他用户的模板"));
            }
            
            // 继续执行优化逻辑
            return promptService.getPromptOptimizationTemplate(request.getOptimizationStyle())
                .flatMap(promptTemplate -> {
                    // ... 优化实现逻辑 ...
                });
        });
}
```

## 6. 性能和可扩展性考虑

1. **模板缓存策略**：
   - 公共模板使用更长时间的缓存
   - 私有模板仅对创建者缓存
   - 缓存分层策略（内存、Redis等）

2. **组件懒加载**：优化结果视图仅在需要时才渲染

3. **分批处理**：对于长文本进行分段优化，降低单次请求负载

4. **缓存机制**：为相似请求实现智能缓存

5. **后台处理**：长时间任务在后台完成，可通过通知中心通知用户

6. **资源限制**：设置用户级别请求频率和长度限制

7. **降级处理**：在高负载情况下提供简化版功能

## 7. 后续扩展计划

1. **模板分享功能**：允许用户申请将优质私有模板升级为公共模板

2. **模板评分系统**：用户可以为公共模板评分和评论

3. **多模型对比**：允许用户同时使用多个模型生成结果并对比

4. **学习用户偏好**：记录用户接受/拒绝的模式，逐步优化生成结果

5. **企业模板库**：企业版用户可以创建团队内共享的模板库

6. **质量评分系统**：自动评估生成提示词的质量，提供改进建议

7. **风格库**：扩展提供更多专业领域的优化风格

## 8. 实现时间估计

1. 前端组件拆分与重构：4人日
2. 模板权限控制实现：2人日
3. 高级UI/UX实现：3人日
4. 后端API扩展：3人日
5. 高级功能实现：2人日
6. 测试与调整：3人日
7. 总计：17人日 