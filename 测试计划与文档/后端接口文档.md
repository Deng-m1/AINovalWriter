# AI小说助手后端接口文档

## 概述

本文档详细描述了AI小说助手（AINoval）应用程序的后端API接口。这些接口支持小说创作管理系统的核心功能，包括小说、章节、场景的创建、读取、更新和删除操作。

## 基础信息

- **基础URL**: `http://localhost:8080/api`
- **内容类型**: `application/json`
- **认证方式**: 暂未实现，当前为开放接口

## 数据结构关系

- **小说(Novel)** 和 **幕(Act)** 是一对多关系
- **幕(Act)** 和 **章节(Chapter)** 是一对多关系
- **章节(Chapter)** 和 **场景(Scene)** 是一对一关系
- **场景(Scene)** 和 **摘要(Summary)** 是一对一关系

## API端点

### 小说管理

#### 获取所有小说

```
GET /novels
```

**响应**:
```json
[
  {
    "id": "1",
    "title": "真有钱了怎么办",
    "coverImagePath": "",
    "createdAt": "2023-01-01T00:00:00Z",
    "updatedAt": "2023-01-10T00:00:00Z",
    "acts": [...]
  },
  ...
]
```

#### 获取单个小说

```
GET /novels/{id}
```

**参数**:
- `id`: 小说ID

**响应**:
```json
{
  "id": "1",
  "title": "真有钱了怎么办",
  "coverImagePath": "",
  "createdAt": "2023-01-01T00:00:00Z",
  "updatedAt": "2023-01-10T00:00:00Z",
  "acts": [
    {
      "id": "act_bc39a709-b537-4a5e-b04d-f88d81f326bf",
      "title": "Act 1",
      "order": 1,
      "chapters": [...]
    },
    ...
  ]
}
```

#### 创建小说

```
POST /novels
```

**请求体**:
```json
{
  "title": "新小说标题"
}
```

**响应**:
```json
{
  "id": "new-1642342342342",
  "title": "新小说标题",
  "coverImagePath": "",
  "createdAt": "2023-06-15T10:30:00Z",
  "updatedAt": "2023-06-15T10:30:00Z",
  "acts": []
}
```

#### 更新小说

```
PUT /novels/{id}
```

**参数**:
- `id`: 小说ID

**请求体**:
```json
{
  "id": "1",
  "title": "更新后的标题",
  "coverImagePath": "",
  "createdAt": "2023-01-01T00:00:00Z",
  "updatedAt": "2023-06-15T11:45:00Z",
  "acts": [...]
}
```

**响应**:
```json
{
  "id": "1",
  "title": "更新后的标题",
  "coverImagePath": "",
  "createdAt": "2023-01-01T00:00:00Z",
  "updatedAt": "2023-06-15T11:45:00Z",
  "acts": [...]
}
```

#### 删除小说

```
DELETE /novels/{id}
```

**参数**:
- `id`: 小说ID

**响应**:
- 状态码: 204 No Content

### 场景管理

#### 获取场景内容

```
GET /novels/{novelId}/acts/{actId}/chapters/{chapterId}/scene
```

**参数**:
- `novelId`: 小说ID
- `actId`: 幕ID
- `chapterId`: 章节ID

**响应**:
```json
{
  "id": "scene_a1b2c3d4",
  "content": "{\"ops\":[{\"insert\":\"场景内容...\"}]}",
  "wordCount": 350,
  "summary": {
    "id": "summary_e5f6g7h8",
    "content": "场景摘要内容..."
  },
  "lastEdited": "2023-06-15T14:30:00Z"
}
```

#### 更新场景内容

```
PUT /novels/{novelId}/acts/{actId}/chapters/{chapterId}/scene
```

**参数**:
- `novelId`: 小说ID
- `actId`: 幕ID
- `chapterId`: 章节ID

**请求体**:
```json
{
  "id": "scene_a1b2c3d4",
  "content": "{\"ops\":[{\"insert\":\"更新后的场景内容...\"}]}",
  "wordCount": 420,
  "summary": {
    "id": "summary_e5f6g7h8",
    "content": "场景摘要内容..."
  },
  "lastEdited": "2023-06-15T15:45:00Z"
}
```

**响应**:
```json
{
  "id": "scene_a1b2c3d4",
  "content": "{\"ops\":[{\"insert\":\"更新后的场景内容...\"}]}",
  "wordCount": 420,
  "summary": {
    "id": "summary_e5f6g7h8",
    "content": "场景摘要内容..."
  },
  "lastEdited": "2023-06-15T15:45:00Z"
}
```

### 摘要管理

#### 更新摘要内容

```
PUT /novels/{novelId}/acts/{actId}/chapters/{chapterId}/summary
```

**参数**:
- `novelId`: 小说ID
- `actId`: 幕ID
- `chapterId`: 章节ID

**请求体**:
```json
{
  "id": "summary_e5f6g7h8",
  "content": "更新后的摘要内容..."
}
```

**响应**:
```json
{
  "id": "summary_e5f6g7h8",
  "content": "更新后的摘要内容..."
}
```

### 编辑器内容管理

#### 获取编辑器内容

```
GET /novels/{novelId}/chapters/{chapterId}/content
```

**参数**:
- `novelId`: 小说ID
- `chapterId`: 章节ID

**响应**:
```json
{
  "id": "chapter_01d78594-054d-4e61-9543-76b5f0f3d424",
  "content": "{\"ops\":[{\"insert\":\"章节内容...\"}]}",
  "lastSaved": "2023-06-15T16:30:00Z",
  "scenes": {
    "act_bc39a709-b537-4a5e-b04d-f88d81f326bf_chapter_01d78594-054d-4e61-9543-76b5f0f3d424": {
      "content": "{\"ops\":[{\"insert\":\"场景内容...\"}]}",
      "summary": "场景摘要...",
      "title": "Chapter 1 · Scene 1",
      "subtitle": ""
    }
  }
}
```

#### 保存编辑器内容

```
PUT /novels/{novelId}/chapters/{chapterId}/content
```

**参数**:
- `novelId`: 小说ID
- `chapterId`: 章节ID

**请求体**:
```json
{
  "id": "chapter_01d78594-054d-4e61-9543-76b5f0f3d424",
  "content": "{\"ops\":[{\"insert\":\"更新后的章节内容...\"}]}",
  "lastSaved": "2023-06-15T17:45:00Z",
  "scenes": {...}
}
```

**响应**:
- 状态码: 200 OK

### 聊天会话管理

#### 获取聊天会话列表

```
GET /novels/{novelId}/chat-sessions
```

**参数**:
- `novelId`: 小说ID

**响应**:
```json
[
  {
    "id": "1",
    "title": "角色设计讨论",
    "createdAt": "2023-06-13T10:00:00Z",
    "lastUpdatedAt": "2023-06-15T15:00:00Z",
    "messages": [...],
    "novelId": "novel-1"
  },
  ...
]
```

#### 创建聊天会话

```
POST /novels/{novelId}/chat-sessions
```

**参数**:
- `novelId`: 小说ID

**请求体**:
```json
{
  "title": "情节构思",
  "chapterId": "chapter_01d78594-054d-4e61-9543-76b5f0f3d424" // 可选
}
```

**响应**:
```json
{
  "id": "session_i9j0k1l2",
  "title": "情节构思",
  "createdAt": "2023-06-15T18:00:00Z",
  "lastUpdatedAt": "2023-06-15T18:00:00Z",
  "messages": [],
  "novelId": "novel-1",
  "chapterId": "chapter_01d78594-054d-4e61-9543-76b5f0f3d424"
}
```

## 错误处理

所有API请求在失败时将返回适当的HTTP状态码和错误消息：

```json
{
  "error": "错误描述",
  "status": 400
}
```

常见错误状态码：
- 400: 请求参数错误
- 404: 资源不存在
- 500: 服务器内部错误

## 缓存机制

为了提高性能和处理网络问题，客户端实现了本地缓存机制：

1. 首次获取数据时，同时保存到本地缓存
2. 后续请求优先从本地缓存获取数据
3. 后台异步从服务器获取最新数据并更新缓存
4. 保存操作先保存到本地缓存，再异步保存到服务器

## ID格式说明

系统中使用的ID格式如下：
- 小说ID: `novel-{数字}` 或 `{数字}`
- 幕ID: `act_{UUID}`
- 章节ID: `chapter_{UUID}`
- 场景ID: `scene_{UUID}`
- 摘要ID: `summary_{UUID}`

