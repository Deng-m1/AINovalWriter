# 后台任务系统 - 后端任务分解 (AINovalServer)

**Version:** 1.1
**Date:** 2024-07-27
**Based on PRD:** 需求文档/后台任务系统需求文档.md (Version 1.0)
**Changes:** Added specifics regarding Virtual Thread configuration and usage (v1.1).

## 1. 核心框架与模型定义 (Foundation & Models)

*   **[Task-Core-01] 定义任务状态枚举 (`TaskStatus.java`):**
    *   位置: `com.ainovel.server.domain.model` or `com.ainovel.server.task.model`
    *   内容: `QUEUED`, `RUNNING`, `COMPLETED`, `FAILED`, `CANCELLED`
    *   复杂度: 低
*   **[Task-Core-02] 定义后台任务数据模型 (`BackgroundTask.java`):**
    *   位置: `com.ainovel.server.domain.model`
    *   注解: `@Document(collection = "background_tasks")`
    *   字段: 根据 PRD Section 10 (id, userId, taskType, status, parameters, progress, result, errorInfo, timestamps).
    *   `parameters`, `progress`, `result`, `errorInfo` 可以是 `Map<String, Object>` 或定义更具体的嵌套类。
    *   复杂度: 中
*   **[Task-Core-03] 定义任务接口 (`BackgroundTaskExecutable.java`):**
    *   位置: `com.ainovel.server.task` or `com.ainovel.server.service.task`
    *   方法: `Mono<Void> execute(TaskContext context);`, `String getTaskType();` (可能需要更多方法如 `cancelHint`, `progressProvider`)
    *   `TaskContext` 可能包含任务 ID、参数、更新状态/进度的方法引用等。
    *   复杂度: 中
*   **[Task-Core-04] 定义任务参数/结果基类/接口 (Optional):**
    *   位置: `com.ainovel.server.task.dto`
    *   目的: 为不同任务的 `parameters` 和 `result` 提供类型安全。
    *   复杂度: 低
*   **[Task-Core-05] 定义任务注册与发现机制:**
    *   方式: 使用 Spring 的 `@Component` 扫描和 `@Qualifier` 或自定义注册表 Bean。
    *   目的: `TaskManagerService` 能根据 `taskType` 找到对应的 `BackgroundTaskExecutable` 实现。
    *   复杂度: 中

## 2. 持久化层 (Persistence Layer)

*   **[Task-Persist-01] 创建 MongoDB Repository (`BackgroundTaskRepository.java`):**
    *   位置: `com.ainovel.server.repository`
    *   继承: `ReactiveMongoRepository<BackgroundTask, String>`
    *   方法:
        *   `findByUserId(String userId, Pageable pageable)`
        *   `findByUserIdAndStatusIn(String userId, List<TaskStatus> statuses, Pageable pageable)`
        *   `findByIdAndUserId(String id, String userId)`
        *   (可能需要) `findStaleRunningTasks(Instant threshold)` - 用于重启恢复检查
    *   复杂度: 低

## 3. 任务管理与执行服务 (Task Management & Execution Service)

*   **[Task-Exec-01] 实现任务管理器 (`TaskManagerService.java`):**
    *   位置: `com.ainovel.server.service.impl` (或 `com.ainovel.server.task.service`)
    *   职责: 接收任务请求、持久化任务、调度执行、更新状态/进度、处理结果/错误。
    *   **依赖:** `BackgroundTaskRepository`, **`@Qualifier("virtualThreadTaskExecutor") ExecutorService`** (确保注入虚拟线程执行器), Task Registry/Discoverer.
    *   复杂度: 高
*   **[Task-Exec-02] 确认/配置虚拟线程 ExecutorService Bean:**
    *   **检查:** `com.ainovel.server.config.VirtualThreadConfig.java` 是否已提供适用于 IO 密集型任务的 `ExecutorService` Bean (e.g., using `Executors.newVirtualThreadPerTaskExecutor()`).
    *   **配置:** 如果需要，调整现有 Bean 或创建一个新的 Bean (e.g., `@Bean("virtualThreadTaskExecutor")`) 专门用于后台任务系统，确保它使用虚拟线程。
    *   **注入:** 确保 `TaskManagerService` 注入此特定的 `ExecutorService` Bean。
    *   复杂度: 低-中 (取决于是否需要修改现有配置)
*   **[Task-Exec-03] 实现任务调度逻辑 (利用虚拟线程):**
    *   在 `TaskManagerService` 中:
        *   `submitTask(userId, taskType, parameters)`: 创建 `BackgroundTask` 对象 (`QUEUED`, 存DB)，然后调用 `virtualThreadTaskExecutor.submit(() -> executeTaskWrapper(taskId))`。
        *   `executeTaskWrapper(taskId)`: 此方法将在虚拟线程上运行。它负责加载任务数据、调用 `BackgroundTaskExecutable.execute()`, 更新状态 (RUNNING -> COMPLETED/FAILED), 保存结果/错误, 处理异常。
    *   **验证:** 确保任务执行逻辑（尤其是涉及网络 IO 如 AI 调用、DB 操作的部分）能够受益于虚拟线程（即不应有长时间占用平台线程的 CPU 密集型阻塞操作）。
    *   复杂度: 高
*   **[Task-Exec-04] 实现状态与进度更新机制:**
    *   `TaskContext` 或 `TaskManagerService` 提供方法供 `BackgroundTaskExecutable` 调用以更新进度。
    *   更新操作应写入 `BackgroundTaskRepository`。
    *   考虑更新频率限制/节流，避免过多 DB写入。
    *   复杂度: 中
*   **[Task-Exec-05] 实现基本并发控制:**
    *   在 `TaskManagerService` 中使用 `Semaphore` 或类似机制限制同时 `RUNNING` 的任务总数或特定类型任务数（*注意：此限制主要针对外部资源如 API 配额或逻辑并发，而非虚拟线程本身*）。
    *   使并发数可配置 (`application.yml`).
    *   复杂度: 中
*   **[Task-Exec-06] 实现任务取消逻辑:**
    *   `TaskManagerService.cancelTask(taskId, userId)`: 检查权限，更新 DB 中任务状态为 `CANCELLING` (或直接 `CANCELLED` 如果尚未运行)。
    *   `BackgroundTaskExecutable.execute()` 实现需要能响应取消信号 (e.g., check `Thread.currentThread().isInterrupted()`). 虚拟线程支持标准中断机制。
    *   在执行包装器中捕获 `InterruptedException` 或检查状态，将最终状态置为 `CANCELLED`。
    *   复杂度: 中
*   **[Task-Exec-07] 实现基本重试逻辑 (针对特定异常):**
    *   在任务执行包装器中捕获可重试异常。
    *   实现简单的重试策略 (e.g., 固定次数、延迟 `Thread.sleep()` 在虚拟线程中是高效的)。
    *   记录重试次数到 `errorInfo`。
    *   复杂度: 中
*   **[Task-Exec-08] 实现服务重启任务恢复/标记 (可选但推荐):**
    *   添加 `@PostConstruct` 或 `ApplicationRunner` Bean。
    *   启动时查询状态为 `RUNNING` 的任务。
    *   将这些任务标记为 `FAILED` 或 `INTERRUPTED`。
    *   复杂度: 中

## 4. API 控制器层 (API Controller Layer)

*   **[Task-API-01] 创建任务控制器 (`TaskController.java`):**
    *   位置: `com.ainovel.server.web.controller`
    *   注解: `@RestController`, `@RequestMapping("/api/tasks")`, `@Tag(name = "Background Tasks")`
    *   依赖: `TaskManagerService`
    *   复杂度: 低
*   **[Task-API-02] 实现创建任务端点:**
    *   `POST /{taskType}` (或修改现有端点支持 `?async=true`)
    *   接收 DTO。
    *   调用 `TaskManagerService.submitTask()`。
    *   返回 `ResponseEntity<Map<String, String>>` (含 `taskId`) 和 `HttpStatus.ACCEPTED`.
    *   需要 `@CurrentUser` 和权限校验。
    *   复杂度: 中
*   **[Task-API-03] 实现获取任务列表端点:**
    *   `GET /`
    *   参数: `@RequestParam status`, `@PageableDefault pageable`
    *   调用 `TaskManagerService.getUserTasks()`。
    *   需要 `@CurrentUser`。
    *   返回 `ResponseEntity<Page<TaskSummaryDTO>>`。
    *   复杂度: 中
*   **[Task-API-04] 实现获取任务详情端点:**
    *   `GET /{taskId}`
    *   调用 `TaskManagerService.getTaskDetails()`。
    *   需要 `@CurrentUser` 和任务归属校验。
    *   返回 `ResponseEntity<TaskDetailsDTO>`。
    *   复杂度: 中
*   **[Task-API-05] 实现取消任务端点:**
    *   `DELETE /{taskId}`
    *   调用 `TaskManagerService.cancelTask()`。
    *   需要 `@CurrentUser` 和任务归属校验。
    *   返回 `ResponseEntity<Void>` 和 `HttpStatus.ACCEPTED`.
    *   复杂度: 低
*   **[Task-API-06] 定义相关 DTO (`TaskCreateDTO`, `TaskSummaryDTO`, `TaskDetailsDTO`):**
    *   位置: `com.ainovel.server.web.dto`
    *   复杂度: 低

## 5. 具体任务实现 (Task Implementations - V1 Scope)

*   **[Task-Impl-01] 实现单场景生成摘要任务 (`GenerateSummaryTask.java`):**
    *   位置: `com.ainovel.server.task.impl`
    *   实现: `BackgroundTaskExecutable`
    *   逻辑: 调用 `SceneService`, `AIService`. 处理 IO 密集操作，适合虚拟线程。
    *   复杂度: 中
*   **[Task-Impl-02] 实现单摘要生成场景任务 (`GenerateSceneTask.java`):**
    *   位置: `com.ainovel.server.task.impl`
    *   实现: `BackgroundTaskExecutable`
    *   逻辑: 调用 `AIService`. 处理 IO 密集操作。
    *   复杂度: 中
*   **[Task-Impl-03] 实现批量场景生成摘要任务 (`BatchGenerateSummaryTask.java`):**
    *   位置: `com.ainovel.server.task.impl`
    *   实现: `BackgroundTaskExecutable`
    *   逻辑: 循环调用 `AIService`。每个 AI 调用是独立的 IO 阻塞，适合虚拟线程并发处理子任务（如果架构允许）或在一个虚拟线程内顺序执行。
    *   复杂度: 高
*   **[Task-Impl-04] 实现批量摘要生成场景任务 (`BatchGenerateSceneTask.java`):**
    *   位置: `com.ainovel.server.task.impl`
    *   实现: `BackgroundTaskExecutable`
    *   逻辑: 类似 Batch Summary。
    *   复杂度: 高

## 6. 集成、配置与测试 (Integration, Configuration & Testing)

*   **[Task-Test-01] 编写单元测试:** (同前)
    *   复杂度: 中
*   **[Task-Test-02] 编写集成测试:** (同前)
    *   **增加:** 验证任务是否在虚拟线程上执行（可通过日志 Mapped Diagnostic Context (MDC) 或调试确认）。
    *   复杂度: 高
*   **[Task-Config-01] 添加相关配置到 `application.yml`:** (同前)
    *   复杂度: 低
*   **[Task-Sec-01] 集成 Spring Security:** (同前)
    *   复杂度: 低
*   **[Task-Log-01] 添加详细日志记录:** (同前)
    *   **增加:** 在日志中包含线程信息 (特别是区分虚拟线程和平台线程) 以便调试。
    *   复杂度: 低

## 7. 文档 (Documentation)

*   **[Task-Doc-01] 更新 API 文档 (Swagger/OpenAPI):** (同前)
    *   复杂度: 低
*   **[Task-Doc-02] 编写后端实现说明 (可选):** (同前)
    *   **增加:** 说明虚拟线程的配置和使用方式。
    *   复杂度: 低

---

**依赖关系与顺序建议:** (保持不变)

